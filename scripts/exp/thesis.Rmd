---
title: "Radiation fast and slow"
author: "Benjamin Haley"
date: "March 30, 2015"
output:
  html_document:
    css: /Users/benjaminhaley/Dropbox/Public/rmarkdown.css
---

## Is acute radiation most dangerous?

I will look at animal survival data and ask two central questions:

1. Are low dose-rate exposures safer than high dose-rate exposures?
2. Are fractionated exposures safer than acute exposures?

```{r echo=FALSE, message=FALSE}
setwd('~/janus')
source('scripts/util/thesis.R') # http://goo.gl/VYzkAs

# Data
setwd('~/janus')
original_data <- readRDS('data/thesis.rds')
controls <- readRDS('data/thesis_controls.rds')
```



```{r}
# Report about the aggregate data
data <- get_data(dose_limit = 4, exclude_stratum=c(), exclude_species=c(), censor=0.0)
aggregated <- aggregate(data, duplicate_controls = FALSE)
report <- aggregated %>%
  mutate(cluster_number = ifelse(is.na(cluster), 0, cluster_number)) %>%
  arrange(stratum_id, cluster_number, dose) %>%
  mutate(stratum = sub("\n *", " ", paste0(stratum_id, ". ", stratum)),
         cluster = paste0(cluster_number, ". ", cluster),
         age = paste(round(raw_lifespan), "+/-", round(raw_lifespan_sem)),
         dose = round(dose, 2)
         )  %>%
  select(stratum, cluster, n, age, dose)
head(report, 3)
write.csv(report, "ozasa data summary.csv", row.names = FALSE)
```

## Just a poisson

```{r}
data <- get_data(dose_limit = 4, exclude_stratum=c(), exclude_species=c(), censor=0.0)
aggregated <- aggregate(data)

model <- glm(n/days_at_risk ~ 
               stratum +
               dose:protracted -
               1,
             family="quasipoisson",
             weights = days_at_risk,
             data=aggregated)
round(report_poisson(model), 3)

#                                                        lower middle upper
# stratum9-6 SCK/CEN ♂ C57BL/Cnb mice\n  γ-ray @84 days  0.002  0.002 0.002
# stratum1003-22 ANL ♂ B6CF1 mice\n  γ-ray @120 days     0.001  0.001 0.001
# stratum9-5 SCK/CEN ♂ BALB/c/Cnb mice\n  γ-ray @84 days 0.001  0.001 0.001
# stratum3-5 ENEA ♂ BC3F1 mice\n  X-ray                  0.001  0.001 0.001
# stratum1003-24 ANL ♂ B6CF1 mice\n  γ-ray               0.001  0.001 0.001
# stratum9-4 SCK/CEN ♂ C57BL/Cnb mice\n  X-ray @28 days  0.001  0.002 0.002
# stratum9-7 SCK/CEN ♂ C57BL/Cnb mice\n  X-ray           0.001  0.001 0.001
# stratum11-2-E TNO ♀ BN/BRIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum11-2-F TNO ♀ BN/BRIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum11-2-F TNO ♀ WAG/RIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum11-2-B TNO ♀ WAG/RIJ rats\n  γ-ray @56 days     0.001  0.001 0.001
# stratum11-2-B TNO ♀ WAG/RIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum1003-24 ANL ♀ B6CF1 mice\n  γ-ray               0.001  0.001 0.001
# stratum11-2-E TNO ♀ WAG/RIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum11-2-E TNO ♀ SD/RIJ rats\n  X-ray @56 days      0.001  0.001 0.001
# stratum11-2-D TNO ♀ WAG/RIJ rats\n  γ-ray @117 days    0.001  0.001 0.001
# stratum11-2-A TNO ♀ WAG/RIJ rats\n  X-ray @56 days     0.001  0.001 0.001
# stratum11-2-D TNO ♀ WAG/RIJ rats\n  γ-ray @56 days     0.001  0.001 0.001
# dose:protractedFALSE                                   1.041  1.053 1.066
# dose:protractedTRUE                                    1.022  1.032 1.042
```


```{r}
# Ozasa style
ozasa_analysis <- function(name, dose_limit=4, exclude_stratum=c(), exclude_species=c(), censor=0.0) {
  
  ## Get data
  data <- get_data(dose_limit = dose_limit, exclude_stratum=c(), exclude_species=c(), censor=censor)
  aggregated <- aggregate(data)
  d <- aggregated
  assign("d", d, envir = .GlobalEnv)
  
  # Show survival
  g <- show_survival(data); print(g)
  ggsave_for_publication(paste(name, "survival.png"), g)
  
  # Model
  baseline <- get_baseline_function(d$stratum_id)
  err <- get_err_function(d$stratum_id)
  start <- get_start_list(d$stratum_id)
  completed <- FALSE
  while(!completed) {
    # Keep modeling until the profile is optimized
    print('modeling')
    model <- build_model(
      get_likelihood_function("mortality", "sem", start, err, baseline),
      start
    )
    h <- model@details$hessian
    h <- h[!rownames(h) %in% "tau2", !colnames(h) %in% "tau2"]
    sd <- sqrt(diag(solve(h)))
    sd['tau2'] <- 0.00001
    sd['err_treatment_age'] <- max(0.5, sd['err_treatment_age'])
    p <- profile(model,
                 which=which(names(start) %in% c("dref", "err_treatment_age")),
                 std.err=sd,
                 try_harder=TRUE)
    if(class(p) == "profile.mle2") {
      completed = TRUE
    } else {
      names(p@fullcoef) <- names(start)
      start <- as.list(p@fullcoef)
    }
  }

  
  # Make predictions (add a control to each cluster for good measure)
  d$prediction <- predict_mle(model, start, err, baseline)
  g <- show_aggregated(d); print(g)
  ggsave_for_publication(paste(name, "ozasa.png"), g)

  # Show coefficients
  print(confint(p, level = 0.99))
  print(confint(p, level = 0.95))
  print(confint(p, level = 0.9))
  get_mle_coefficients(model)
}

ozasa_analysis("1 - 4 Sv", dose_limit = 4)
# ozasa_analysis("1 - 3 Sv", dose_limit = 3)
ozasa_analysis("without poisioning", 
                dose_limit = 4,
                stratum_with_acute_poisoning)
# ozasa_analysis("censor 6 percent", 
#                 dose_limit = 4, 
#                 censor=5/75)
# ozasa_analysis("censor 13 percent", 
#                dose_limit = 4, 
#                censor=10/75)
# ozasa_analysis("censor 26 percent", 
#                dose_limit = 4, 
#                censor=20/75)










# > ozasa_analysis("1 - 4 Sv", dose_limit = 4)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  11528 animals 115 groups 8 studies. 
# 
# [1] "modeling"
#                        0.5 %    99.5 %
# dref               0.3325514 0.6665970
# err_treatment_age -5.7810702 0.1959173
#                        2.5 %     97.5 %
# dref               0.3657365 0.61048985
# err_treatment_age -4.4700282 0.04121277
#                          5 %       95 %
# dref               0.3832508  0.5851187
# err_treatment_age -3.9041052 -0.1244572
#                          x       o    lower    upper
# r_1                1.02300 0.01514  0.99334  1.05267
# r_2                1.03471 0.00946  1.01618  1.05324
# r_3                1.01034 0.01556  0.97984  1.04084
# r_4                1.06070 0.00720  1.04658  1.07482
# r_5                1.00028 0.01107  0.97859  1.02197
# r_6                0.95239 0.04488  0.86443  1.04035
# r_7                0.95158 0.02847  0.89578  1.00737
# r_8                1.00626 0.01549  0.97590  1.03662
# r_9                0.99641 0.02724  0.94301  1.04981
# r_10               1.03013 0.01407  1.00255  1.05770
# r_11               1.00467 0.01746  0.97045  1.03889
# r_12               0.99896 0.01892  0.96188  1.03603
# r_13               0.99985 0.01609  0.96831  1.03138
# r_14               0.98840 0.02182  0.94563  1.03117
# r_15               0.98391 0.04585  0.89405  1.07377
# r_16               1.02904 0.02681  0.97649  1.08158
# r_17               0.99350 0.02214  0.95010  1.03690
# r_18               1.01591 0.05900  0.90027  1.13155
# err_1              0.08206 0.02307  0.03684  0.12727
# err_2              0.07076 0.01918  0.03316  0.10835
# err_3              0.07256 0.02150  0.03043  0.11470
# err_4              0.01341 0.00611  0.00143  0.02539
# err_5              0.02208 0.01854 -0.01425  0.05841
# err_6              0.12684 0.05042  0.02801  0.22567
# err_7              0.11759 0.04322  0.03288  0.20231
# err_8              0.08569 0.02360  0.03943  0.13196
# err_9              0.10422 0.04592  0.01422  0.19422
# err_10             0.15467 0.03376  0.08851  0.22084
# err_11             0.12664 0.02599  0.07570  0.17759
# err_12             0.08767 0.02953  0.02979  0.14555
# err_13             0.09646 0.05325 -0.00790  0.20082
# err_14             0.12061 0.03160  0.05868  0.18255
# err_15             0.18400 0.05311  0.07990  0.28810
# err_16             0.06297 0.04708 -0.02931  0.15525
# err_17             0.13125 0.07474 -0.01524  0.27773
# err_18             0.10799 0.04435  0.02106  0.19492
# dref               0.48051 0.06317  0.35670  0.60433
# err_treatment_age -1.68047 1.03427 -3.70765  0.34671
# tau2              -0.00008 0.00000 -0.00008 -0.00008

# 
# > ozasa_analysis("1 - 3 Sv", dose_limit = 3)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  10147 animals 99 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  9050 animals 90 groups 6 studies. 
# 
# After filtering excluded strata:  
#  9050 animals 90 groups 6 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  8877 animals 90 groups 6 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  8877 animals 90 groups 6 studies. 
# 
# [1] "modeling"
#                         0.5 %    99.5 %
# dref                0.1795791 0.6241289
# err_treatment_age -18.7409976 1.4121786
#                        2.5 %    97.5 %
# dref               0.2271945 0.5584549
# err_treatment_age -9.3626492 0.9202988
#                          5 %      95 %
# dref               0.2515571 0.5263823
# err_treatment_age -7.1942082 0.6277799
#                          x       o    lower    upper
# r_1                1.02104 0.01723  0.98726  1.05482
# r_2                1.01856 0.01741  0.98443  1.05268
# r_3                1.04018 0.01243  1.01581  1.06454
# r_4                1.05460 0.01043  1.03415  1.07505
# r_5                0.95348 0.03112  0.89248  1.01449
# r_6                1.01176 0.01888  0.97475  1.04877
# r_7                0.99911 0.02684  0.94650  1.05172
# r_8                1.03538 0.01574  1.00452  1.06624
# r_9                1.01261 0.01902  0.97534  1.04989
# r_10               1.00673 0.02063  0.96628  1.04717
# r_11               1.03287 0.02692  0.98011  1.08562
# r_12               0.99538 0.02284  0.95062  1.04014
# r_13               0.99103 0.02367  0.94463  1.03743
# r_14               0.99130 0.04579  0.90155  1.08105
# err_1              0.09649 0.03190  0.03395  0.15902
# err_2              0.05102 0.02868 -0.00520  0.10724
# err_3              0.07395 0.03540  0.00456  0.14334
# err_4              0.01373 0.00927 -0.00443  0.03189
# err_5              0.11730 0.04515  0.02881  0.20580
# err_6              0.05321 0.07549 -0.09474  0.20117
# err_7              0.11140 0.04789  0.01754  0.20526
# err_8              0.15465 0.03555  0.08497  0.22433
# err_9              0.13360 0.02717  0.08034  0.18686
# err_10             0.09172 0.03200  0.02900  0.15445
# err_11             0.05997 0.04936 -0.03677  0.15672
# err_12             0.13284 0.07541 -0.01496  0.28065
# err_13             0.11755 0.03866  0.04178  0.19332
# err_14             0.20173 0.05718  0.08966  0.31381
# dref               0.37746 0.07547  0.22954  0.52538
# err_treatment_age -1.86578 0.00170 -1.86911 -1.86244
# tau2               0.00012 0.00012 -0.00011  0.00036

# 
# ozasa_analysis("without poisioning", 
# +                 dose_limit = 4,
# +                 stratum_with_acute_poisoning)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  10600 animals 103 groups 6 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  10399 animals 103 groups 6 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  10399 animals 103 groups 6 studies. 
# 
# [1] "modeling"
#                        0.5 %    99.5 %
# dref               0.3144702 0.6553191
# err_treatment_age -5.9471356 1.0198560
#                        2.5 %    97.5 %
# dref               0.3504308 0.6045190
# err_treatment_age -4.5695067 0.2455966
#                          5 %       95 %
# dref               0.3690488  0.5802367
# err_treatment_age -4.0009490 -0.1331447
#                          x       o    lower    upper
# r_1                1.02296 0.01510  0.99337  1.05255
# r_2                1.03469 0.00946  1.01616  1.05322
# r_3                1.01069 0.01555  0.98022  1.04116
# r_4                1.06073 0.00720  1.04661  1.07485
# r_5                1.00022 0.01108  0.97850  1.02194
# r_6                1.00637 0.01548  0.97604  1.03671
# r_7                0.99653 0.02712  0.94338  1.04967
# r_8                1.03041 0.01405  1.00287  1.05796
# r_9                1.00534 0.01742  0.97121  1.03948
# r_10               0.99965 0.01883  0.96275  1.03656
# r_11               0.99980 0.01610  0.96825  1.03135
# r_12               0.98864 0.02179  0.94593  1.03135
# r_13               0.98434 0.04569  0.89480  1.07388
# r_14               1.02957 0.02665  0.97733  1.08182
# r_15               0.99375 0.02206  0.95052  1.03698
# r_16               1.01916 0.05903  0.90346  1.13485
# err_1              0.08329 0.02337  0.03749  0.12910
# err_2              0.07318 0.02011  0.03375  0.11260
# err_3              0.07270 0.02168  0.03021  0.11520
# err_4              0.01346 0.00612  0.00147  0.02545
# err_5              0.02276 0.01919 -0.01485  0.06038
# err_6              0.08577 0.02364  0.03943  0.13210
# err_7              0.10552 0.04620  0.01497  0.19606
# err_8              0.15545 0.03400  0.08880  0.22210
# err_9              0.12801 0.02614  0.07677  0.17925
# err_10             0.08866 0.02985  0.03016  0.14715
# err_11             0.09867 0.05528 -0.00967  0.20701
# err_12             0.12288 0.03213  0.05992  0.18585
# err_13             0.18713 0.05364  0.08198  0.29227
# err_14             0.06261 0.04719 -0.02987  0.15509
# err_15             0.13125 0.07470 -0.01516  0.27766
# err_16             0.10617 0.04441  0.01914  0.19320
# dref               0.46686 0.06329  0.34282  0.59090
# err_treatment_age -1.70435 1.04737 -3.75720  0.34849
# tau2              -0.00009 0.00000 -0.00009 -0.00009
# There were 16 warnings (use warnings() to see them)


# > ozasa_analysis("censor 6 percent", 
# +                 dose_limit = 4, 
# +                 censor=5/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  7 % of median lifespan after the final treatment  
#  11431 animals 115 groups 8 studies. 
# 
# [1] "modeling"
#                        0.5 %    99.5 %
# dref               0.3189876 0.6376277
# err_treatment_age -5.1190923 0.7304285
#                        2.5 %    97.5 %
# dref               0.3562743 0.5876188
# err_treatment_age -3.6925902 0.6746428
#                          5 %      95 %
# dref               0.3732171 0.5631961
# err_treatment_age -3.3293241 0.6460998
#                          x       o    lower    upper
# r_1                1.01959 0.01377  0.99261  1.04658
# r_2                1.03608 0.00955  1.01737  1.05479
# r_3                1.01076 0.01212  0.98699  1.03452
# r_4                1.05998 0.00930  1.04176  1.07821
# r_5                1.00099 0.01195  0.97757  1.02442
# r_6                0.98536 0.02468  0.93699  1.03373
# r_7                0.94976 0.02933  0.89226  1.00725
# r_8                1.00649 0.01570  0.97571  1.03727
# r_9                0.99628 0.02718  0.94301  1.04956
# r_10               1.03223 0.01461  1.00360  1.06087
# r_11               1.00673 0.01695  0.97351  1.03996
# r_12               1.00154 0.01897  0.96436  1.03872
# r_13               0.99996 0.01592  0.96876  1.03117
# r_14               0.98816 0.02243  0.94420  1.03212
# r_15               0.98547 0.04587  0.89556  1.07538
# r_16               1.02976 0.02687  0.97710  1.08242
# r_17               0.99402 0.02235  0.95022  1.03783
# r_18               1.01920 0.05884  0.90387  1.13454
# err_1              0.07639 0.01794  0.04123  0.11155
# err_2              0.07109 0.01587  0.03999  0.10218
# err_3              0.06621 0.01523  0.03636  0.09607
# err_4              0.01142 0.00631 -0.00095  0.02379
# err_5              0.02207 0.01715 -0.01154  0.05568
# err_6              0.10449 0.03623  0.03348  0.17549
# err_7              0.12063 0.04392  0.03454  0.20671
# err_8              0.08510 0.02284  0.04034  0.12986
# err_9              0.10605 0.04568  0.01653  0.19558
# err_10             0.15084 0.03294  0.08628  0.21540
# err_11             0.12165 0.02323  0.07612  0.16717
# err_12             0.07561 0.02533  0.02596  0.12526
# err_13             0.07850 0.02870  0.02225  0.13476
# err_14             0.12344 0.03125  0.06220  0.18468
# err_15             0.18623 0.05138  0.08552  0.28695
# err_16             0.06074 0.04601 -0.02944  0.15091
# err_17             0.13034 0.07367 -0.01405  0.27474
# err_18             0.10509 0.04406  0.01873  0.19145
# dref               0.45373 0.05988  0.33637  0.57109
# err_treatment_age -1.51772 0.00152 -1.52070 -1.51473
# tau2               0.00003 0.00008 -0.00013  0.00019


# 
# > ozasa_analysis("censor 13 percent", 
# +                dose_limit = 4, 
# +                censor=10/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  13 % of median lifespan after the final treatment  
#  11258 animals 115 groups 8 studies. 
# 
# [1] "modeling"
#                        0.5 %    99.5 %
# dref               0.3072635 0.6264804
# err_treatment_age -3.6351174 2.3867015
#                        2.5 %    97.5 %
# dref               0.3398773 0.5804242
# err_treatment_age -2.4706194 1.5768480
#                          5 %      95 %
# dref               0.3568367 0.5568594
# err_treatment_age -2.0105082 1.1578074
#                          x       o    lower    upper
# r_1                1.02083 0.01283  0.99568  1.04597
# r_2                1.03765 0.01103  1.01604  1.05926
# r_3                1.01165 0.01232  0.98750  1.03580
# r_4                1.04002 0.00873  1.02291  1.05714
# r_5                0.99998 0.01546  0.96967  1.03029
# r_6                0.98803 0.02604  0.93698  1.03907
# r_7                1.00503 0.02305  0.95984  1.05021
# r_8                1.00401 0.01517  0.97427  1.03376
# r_9                1.00494 0.02608  0.95381  1.05607
# r_10               1.03367 0.01591  1.00249  1.06484
# r_11               1.00317 0.01776  0.96835  1.03798
# r_12               1.00617 0.02091  0.96518  1.04717
# r_13               1.00016 0.01821  0.96446  1.03585
# r_14               0.98821 0.02439  0.94042  1.03601
# r_15               0.98401 0.04699  0.89191  1.07610
# r_16               1.03024 0.02803  0.97531  1.08517
# r_17               0.99367 0.02345  0.94770  1.03963
# r_18               1.00961 0.06009  0.89184  1.12738
# err_1              0.05356 0.01260  0.02886  0.07826
# err_2              0.05353 0.01374  0.02660  0.08045
# err_3              0.05567 0.01283  0.03052  0.08082
# err_4              0.01197 0.00469  0.00278  0.02117
# err_5              0.01048 0.01193 -0.01290  0.03386
# err_6              0.08735 0.03203  0.02458  0.15012
# err_7              0.05568 0.03098 -0.00504  0.11640
# err_8              0.07866 0.02139  0.03673  0.12059
# err_9              0.09834 0.04125  0.01748  0.17919
# err_10             0.13827 0.03162  0.07629  0.20025
# err_11             0.10890 0.02174  0.06628  0.15152
# err_12             0.05752 0.02222  0.01397  0.10107
# err_13             0.04770 0.01734  0.01371  0.08168
# err_14             0.11229 0.02968  0.05412  0.17046
# err_15             0.16768 0.04753  0.07452  0.26083
# err_16             0.05138 0.04094 -0.02887  0.13163
# err_17             0.12146 0.06925 -0.01427  0.25719
# err_18             0.10225 0.04113  0.02163  0.18287
# dref               0.45066 0.05940  0.33425  0.56708
# err_treatment_age -0.21578 0.00111 -0.21795 -0.21361
# tau2               0.00014 0.00010 -0.00006  0.00033
# There were 21 warnings (use warnings() to see them)

# 
# > ozasa_analysis("censor 26 percent", 
# +                dose_limit = 4, 
# +                censor=20/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  27 % of median lifespan after the final treatment  
#  10591 animals 115 groups 8 studies. 
# 
# [1] "modeling"
#                        0.5 %    99.5 %
# dref               0.3286674 0.5925908
# err_treatment_age -3.3259935 2.3892750
#                        2.5 %    97.5 %
# dref               0.3579258 0.5339952
# err_treatment_age -2.3276138 1.6522890
#                          5 %      95 %
# dref               0.3731114 0.5216835
# err_treatment_age -1.8848417 1.2313478
#                          x       o    lower    upper
# r_1                1.04134 0.00929  1.02313  1.05954
# r_2                1.03984 0.00896  1.02227  1.05741
# r_3                1.01537 0.00996  0.99585  1.03488
# r_4                1.02609 0.00634  1.01365  1.03852
# r_5                1.00914 0.01331  0.98305  1.03523
# r_6                1.00689 0.01906  0.96952  1.04426
# r_7                1.00005 0.01176  0.97701  1.02310
# r_8                1.00107 0.01752  0.96673  1.03541
# r_9                1.01178 0.01978  0.97300  1.05055
# r_10               1.03138 0.01476  1.00244  1.06031
# r_11               1.00568 0.01458  0.97711  1.03426
# r_12               1.00647 0.01749  0.97218  1.04076
# r_13               1.00007 0.01469  0.97128  1.02886
# r_14               0.98796 0.02292  0.94304  1.03288
# r_15               0.99487 0.03051  0.93506  1.05467
# r_16               1.02963 0.02729  0.97615  1.08311
# r_17               0.99378 0.02272  0.94925  1.03831
# r_18               1.00457 0.04086  0.92449  1.08465
# err_1              0.03583 0.00747  0.02119  0.05048
# err_2              0.04931 0.01091  0.02792  0.07070
# err_3              0.04412 0.00938  0.02574  0.06251
# err_4              0.01003 0.00356  0.00305  0.01702
# err_5              0.08093 0.02105  0.03967  0.12219
# err_6              0.04937 0.02131  0.00761  0.09114
# err_7              0.00973 0.00924 -0.00839  0.02784
# err_8              0.01869 0.01693 -0.01450  0.05187
# err_9              0.11025 0.03698  0.03777  0.18274
# err_10             0.14029 0.03070  0.08012  0.20045
# err_11             0.08190 0.01608  0.05039  0.11341
# err_12             0.04918 0.01735  0.01517  0.08319
# err_13             0.04142 0.01453  0.01294  0.06989
# err_14             0.11043 0.02345  0.06446  0.15639
# err_15             0.15663 0.03259  0.09276  0.22049
# err_16             0.05227 0.03991 -0.02596  0.13050
# err_17             0.12100 0.06862 -0.01349  0.25549
# err_18             0.12357 0.03086  0.06308  0.18406
# dref               0.45742 0.05212  0.35526  0.55957
# err_treatment_age -0.25151 0.00106 -0.25359 -0.24943
# tau2               0.00006 0.00006 -0.00006  0.00018


























# Happens with 1-3 Sv
# If we increase Tau2 to at least 0.1, 0.01, 0.0001 it goes away. 
# Though, if we increase Tau2 only to 0.000025 it remains
# Likelihood
#   It looks like the confidence intervals are actually narrower than they should be
      # 0         Log-likelihood: 181.37
      # -8.39085  Log-likelihood: 180.62
      # -8.40436  Log-likelihood: 180.61
      # -8.41786  Log-likelihood: 180.61
      # -200      Log-likelihood: 163.68

# 
# > ozasa_analysis("1 - 4 Sv", dose_limit = 4)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  11528 animals 115 groups 8 studies. 
# 
#                          x       o    lower    upper
# r_1                1.02300 0.01514  0.99334  1.05267
# r_2                1.03471 0.00946  1.01618  1.05324
# r_3                1.01034 0.01556  0.97984  1.04084
# r_4                1.06070 0.00720  1.04658  1.07482
# r_5                1.00028 0.01107  0.97859  1.02197
# r_6                0.95239 0.04488  0.86443  1.04035
# r_7                0.95158 0.02847  0.89578  1.00737
# r_8                1.00626 0.01549  0.97590  1.03662
# r_9                0.99641 0.02724  0.94301  1.04981
# r_10               1.03013 0.01407  1.00255  1.05770
# r_11               1.00467 0.01746  0.97045  1.03889
# r_12               0.99896 0.01892  0.96188  1.03603
# r_13               0.99985 0.01609  0.96831  1.03138
# r_14               0.98840 0.02182  0.94563  1.03117
# r_15               0.98391 0.04585  0.89405  1.07377
# r_16               1.02904 0.02681  0.97649  1.08158
# r_17               0.99350 0.02214  0.95010  1.03690
# r_18               1.01591 0.05900  0.90027  1.13155
# err_1              0.08206 0.02307  0.03684  0.12727
# err_2              0.07076 0.01918  0.03316  0.10835
# err_3              0.07256 0.02150  0.03043  0.11470
# err_4              0.01341 0.00611  0.00143  0.02539
# err_5              0.02208 0.01854 -0.01425  0.05841
# err_6              0.12684 0.05042  0.02801  0.22567
# err_7              0.11759 0.04322  0.03288  0.20231
# err_8              0.08569 0.02360  0.03943  0.13196
# err_9              0.10422 0.04592  0.01422  0.19422
# err_10             0.15467 0.03376  0.08851  0.22084
# err_11             0.12664 0.02599  0.07570  0.17759
# err_12             0.08767 0.02953  0.02979  0.14555
# err_13             0.09646 0.05325 -0.00790  0.20082
# err_14             0.12061 0.03160  0.05868  0.18255
# err_15             0.18400 0.05311  0.07990  0.28810
# err_16             0.06297 0.04708 -0.02931  0.15525
# err_17             0.13125 0.07474 -0.01524  0.27773
# err_18             0.10799 0.04435  0.02106  0.19492
# dref               0.48051 0.06317  0.35670  0.60433
# err_treatment_age -1.68047 1.03427 -3.70765  0.34671
# tau2              -0.00008 0.00000 -0.00008 -0.00008
# > ozasa_analysis("1 - 3 Sv", dose_limit = 3)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  10147 animals 99 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  9733 animals 94 groups 7 studies. 
# 
# After filtering excluded strata:  
#  9733 animals 94 groups 7 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  9556 animals 94 groups 7 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  9556 animals 94 groups 7 studies. 
# 
#                          x       o    lower    upper
# r_1                1.02137 0.01638  0.98928  1.05347
# r_2                1.01798 0.01660  0.98545  1.05052
# r_3                1.03887 0.01084  1.01762  1.06012
# r_4                1.06161 0.01015  1.04171  1.08151
# r_5                0.95192 0.02872  0.89562  1.00822
# r_6                1.01120 0.01808  0.97576  1.04664
# r_7                1.00021 0.01262  0.97548  1.02494
# r_8                0.99886 0.02636  0.94719  1.05053
# r_9                1.03255 0.01437  1.00438  1.06071
# r_10               1.01150 0.01740  0.97739  1.04561
# r_11               1.00528 0.01866  0.96871  1.04184
# r_12               1.00003 0.01661  0.96747  1.03258
# r_13               1.03256 0.02587  0.98186  1.08327
# r_14               0.99524 0.02174  0.95263  1.03785
# r_15               0.99186 0.02176  0.94920  1.03452
# r_16               0.99077 0.04491  0.90275  1.07879
# err_1              0.10170 0.03242  0.03816  0.16524
# err_2              0.05417 0.02867 -0.00202  0.11036
# err_3              0.08119 0.03200  0.01847  0.14390
# err_4              0.00901 0.00896 -0.00855  0.02657
# err_5              0.11824 0.04376  0.03247  0.20400
# err_6              0.05572 0.07590 -0.09304  0.20449
# err_7              0.02630 0.03393 -0.04020  0.09281
# err_8              0.11350 0.04815  0.01913  0.20788
# err_9              0.16291 0.03500  0.09431  0.23151
# err_10             0.13764 0.02641  0.08587  0.18940
# err_11             0.09674 0.03097  0.03604  0.15744
# err_12             0.12772 0.06138  0.00740  0.24803
# err_13             0.06359 0.04966 -0.03374  0.16092
# err_14             0.13471 0.07603 -0.01432  0.28373
# err_15             0.11783 0.03799  0.04337  0.19230
# err_16             0.20703 0.05790  0.09355  0.32050
# dref               0.38808 0.07348  0.24406  0.53211
# err_treatment_age -2.27746 0.00442 -2.28613 -2.26879
# tau2               0.00001 0.00008 -0.00015  0.00018
# > ozasa_analysis("without poisioning", 
# +                 dose_limit = 4,
# +                 stratum_with_acute_poisoning)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  10600 animals 103 groups 6 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  10399 animals 103 groups 6 studies. 
# 
# After censoring animals that died within  0 % of median lifespan after the final treatment  
#  10399 animals 103 groups 6 studies. 
# 
#                          x       o    lower    upper
# r_1                1.02296 0.01510  0.99337  1.05255
# r_2                1.03469 0.00946  1.01616  1.05322
# r_3                1.01069 0.01555  0.98022  1.04116
# r_4                1.06073 0.00720  1.04661  1.07485
# r_5                1.00022 0.01108  0.97850  1.02194
# r_6                1.00637 0.01548  0.97604  1.03671
# r_7                0.99653 0.02712  0.94338  1.04967
# r_8                1.03041 0.01405  1.00287  1.05796
# r_9                1.00534 0.01742  0.97121  1.03948
# r_10               0.99965 0.01883  0.96275  1.03656
# r_11               0.99980 0.01610  0.96825  1.03135
# r_12               0.98864 0.02179  0.94593  1.03135
# r_13               0.98434 0.04569  0.89480  1.07388
# r_14               1.02957 0.02665  0.97733  1.08182
# r_15               0.99375 0.02206  0.95052  1.03698
# r_16               1.01916 0.05903  0.90346  1.13485
# err_1              0.08329 0.02337  0.03749  0.12910
# err_2              0.07318 0.02011  0.03375  0.11260
# err_3              0.07270 0.02168  0.03021  0.11520
# err_4              0.01346 0.00612  0.00147  0.02545
# err_5              0.02276 0.01919 -0.01485  0.06038
# err_6              0.08577 0.02364  0.03943  0.13210
# err_7              0.10552 0.04620  0.01497  0.19606
# err_8              0.15545 0.03400  0.08880  0.22210
# err_9              0.12801 0.02614  0.07677  0.17925
# err_10             0.08866 0.02985  0.03016  0.14715
# err_11             0.09867 0.05528 -0.00967  0.20701
# err_12             0.12288 0.03213  0.05992  0.18585
# err_13             0.18713 0.05364  0.08198  0.29227
# err_14             0.06261 0.04719 -0.02987  0.15509
# err_15             0.13125 0.07470 -0.01516  0.27766
# err_16             0.10617 0.04441  0.01914  0.19320
# dref               0.46686 0.06329  0.34282  0.59090
# err_treatment_age -1.70435 1.04737 -3.75720  0.34849
# tau2              -0.00009 0.00000 -0.00009 -0.00009
# > ozasa_analysis("censor 6 percent", 
# +                 dose_limit = 4, 
# +                 censor=5/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  7 % of median lifespan after the final treatment  
#  11431 animals 115 groups 8 studies. 
# 
#                          x       o    lower    upper
# r_1                1.01959 0.01377  0.99261  1.04658
# r_2                1.03608 0.00955  1.01737  1.05479
# r_3                1.01076 0.01212  0.98699  1.03452
# r_4                1.05998 0.00930  1.04176  1.07821
# r_5                1.00099 0.01195  0.97757  1.02442
# r_6                0.98536 0.02468  0.93699  1.03373
# r_7                0.94976 0.02933  0.89226  1.00725
# r_8                1.00649 0.01570  0.97571  1.03727
# r_9                0.99628 0.02718  0.94301  1.04956
# r_10               1.03223 0.01461  1.00360  1.06087
# r_11               1.00673 0.01695  0.97351  1.03996
# r_12               1.00154 0.01897  0.96436  1.03872
# r_13               0.99996 0.01592  0.96876  1.03117
# r_14               0.98816 0.02243  0.94420  1.03212
# r_15               0.98547 0.04587  0.89556  1.07538
# r_16               1.02976 0.02687  0.97710  1.08242
# r_17               0.99402 0.02235  0.95022  1.03783
# r_18               1.01920 0.05884  0.90387  1.13454
# err_1              0.07639 0.01794  0.04123  0.11155
# err_2              0.07109 0.01587  0.03999  0.10218
# err_3              0.06621 0.01523  0.03636  0.09607
# err_4              0.01142 0.00631 -0.00095  0.02379
# err_5              0.02207 0.01715 -0.01154  0.05568
# err_6              0.10449 0.03623  0.03348  0.17549
# err_7              0.12063 0.04392  0.03454  0.20671
# err_8              0.08510 0.02284  0.04034  0.12986
# err_9              0.10605 0.04568  0.01653  0.19558
# err_10             0.15084 0.03294  0.08628  0.21540
# err_11             0.12165 0.02323  0.07612  0.16717
# err_12             0.07561 0.02533  0.02596  0.12526
# err_13             0.07850 0.02870  0.02225  0.13476
# err_14             0.12344 0.03125  0.06220  0.18468
# err_15             0.18623 0.05138  0.08552  0.28695
# err_16             0.06074 0.04601 -0.02944  0.15091
# err_17             0.13034 0.07367 -0.01405  0.27474
# err_18             0.10509 0.04406  0.01873  0.19145
# dref               0.45373 0.05988  0.33637  0.57109
# err_treatment_age -1.51772 0.00152 -1.52070 -1.51473
# tau2               0.00003 0.00008 -0.00013  0.00019
# > ozasa_analysis("censor 13 percent", 
# +                dose_limit = 4, 
# +                censor=10/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  13 % of median lifespan after the final treatment  
#  11258 animals 115 groups 8 studies. 
# 
#                          x       o    lower    upper
# r_1                1.02083 0.01283  0.99568  1.04597
# r_2                1.03765 0.01103  1.01604  1.05926
# r_3                1.01165 0.01232  0.98750  1.03580
# r_4                1.04002 0.00873  1.02291  1.05714
# r_5                0.99998 0.01546  0.96967  1.03029
# r_6                0.98803 0.02604  0.93698  1.03907
# r_7                1.00503 0.02305  0.95984  1.05021
# r_8                1.00401 0.01517  0.97427  1.03376
# r_9                1.00494 0.02608  0.95381  1.05607
# r_10               1.03367 0.01591  1.00249  1.06484
# r_11               1.00317 0.01776  0.96835  1.03798
# r_12               1.00617 0.02091  0.96518  1.04717
# r_13               1.00016 0.01821  0.96446  1.03585
# r_14               0.98821 0.02439  0.94042  1.03601
# r_15               0.98401 0.04699  0.89191  1.07610
# r_16               1.03024 0.02803  0.97531  1.08517
# r_17               0.99367 0.02345  0.94770  1.03963
# r_18               1.00961 0.06009  0.89184  1.12738
# err_1              0.05356 0.01260  0.02886  0.07826
# err_2              0.05353 0.01374  0.02660  0.08045
# err_3              0.05567 0.01283  0.03052  0.08082
# err_4              0.01197 0.00469  0.00278  0.02117
# err_5              0.01048 0.01193 -0.01290  0.03386
# err_6              0.08735 0.03203  0.02458  0.15012
# err_7              0.05568 0.03098 -0.00504  0.11640
# err_8              0.07866 0.02139  0.03673  0.12059
# err_9              0.09834 0.04125  0.01748  0.17919
# err_10             0.13827 0.03162  0.07629  0.20025
# err_11             0.10890 0.02174  0.06628  0.15152
# err_12             0.05752 0.02222  0.01397  0.10107
# err_13             0.04770 0.01734  0.01371  0.08168
# err_14             0.11229 0.02968  0.05412  0.17046
# err_15             0.16768 0.04753  0.07452  0.26083
# err_16             0.05138 0.04094 -0.02887  0.13163
# err_17             0.12146 0.06925 -0.01427  0.25719
# err_18             0.10225 0.04113  0.02163  0.18287
# dref               0.45066 0.05940  0.33425  0.56708
# err_treatment_age -0.21578 0.00111 -0.21795 -0.21361
# tau2               0.00014 0.00010 -0.00006  0.00033
# > ozasa_analysis("censor 26 percent", 
# +                dose_limit = 4, 
# +                censor=20/75)
# Originally:  
#  14782 animals 143 groups 8 studies. 
# 
# After filtering for dose:  
#  11730 animals 115 groups 8 studies. 
# 
# Directly compare acute and fractionated exposures or age at exposure.:  
#  11730 animals 115 groups 8 studies. 
# 
# After filtering excluded strata:  
#  11730 animals 115 groups 8 studies. 
# 
# After censoring animals that died before the final treatment in thier strata,  
#  11528 animals 115 groups 8 studies. 
# 
# After censoring animals that died within  27 % of median lifespan after the final treatment  
#  10591 animals 115 groups 8 studies. 
# 
#                          x       o    lower    upper
# r_1                1.04134 0.00929  1.02313  1.05954
# r_2                1.03984 0.00896  1.02227  1.05741
# r_3                1.01537 0.00996  0.99585  1.03488
# r_4                1.02609 0.00634  1.01365  1.03852
# r_5                1.00914 0.01331  0.98305  1.03523
# r_6                1.00689 0.01906  0.96952  1.04426
# r_7                1.00005 0.01176  0.97701  1.02310
# r_8                1.00107 0.01752  0.96673  1.03541
# r_9                1.01178 0.01978  0.97300  1.05055
# r_10               1.03138 0.01476  1.00244  1.06031
# r_11               1.00568 0.01458  0.97711  1.03426
# r_12               1.00647 0.01749  0.97218  1.04076
# r_13               1.00007 0.01469  0.97128  1.02886
# r_14               0.98796 0.02292  0.94304  1.03288
# r_15               0.99487 0.03051  0.93506  1.05467
# r_16               1.02963 0.02729  0.97615  1.08311
# r_17               0.99378 0.02272  0.94925  1.03831
# r_18               1.00457 0.04086  0.92449  1.08465
# err_1              0.03583 0.00747  0.02119  0.05048
# err_2              0.04931 0.01091  0.02792  0.07070
# err_3              0.04412 0.00938  0.02574  0.06251
# err_4              0.01003 0.00356  0.00305  0.01702
# err_5              0.08093 0.02105  0.03967  0.12219
# err_6              0.04937 0.02131  0.00761  0.09114
# err_7              0.00973 0.00924 -0.00839  0.02784
# err_8              0.01869 0.01693 -0.01450  0.05187
# err_9              0.11025 0.03698  0.03777  0.18274
# err_10             0.14029 0.03070  0.08012  0.20045
# err_11             0.08190 0.01608  0.05039  0.11341
# err_12             0.04918 0.01735  0.01517  0.08319
# err_13             0.04142 0.01453  0.01294  0.06989
# err_14             0.11043 0.02345  0.06446  0.15639
# err_15             0.15663 0.03259  0.09276  0.22049
# err_16             0.05227 0.03991 -0.02596  0.13050
# err_17             0.12100 0.06862 -0.01349  0.25549
# err_18             0.12357 0.03086  0.06308  0.18406
# dref               0.45742 0.05212  0.35526  0.55957
# err_treatment_age -0.25151 0.00106 -0.25359 -0.24943
# tau2               0.00006 0.00006 -0.00006  0.00018
```



*Things I have checked*
I worry about all sorts of random stuff. Here are things I worried about, but seem fine:

- [x] Make sure none of the aggregates look like duplicates.

*To Try*  
- Rerun the analysis without 9-4, 9-6, and 9-7 ![][1] (and anything else that shows signs of acute death)
- Use only one gender at a time
- Try calculating mortality rates only after inclusion, right now I add all of lifespan even if we exclude animals that die when young. Perhaps I should only use lifespan since some time.

[1]: http://dl.dropbox.com/u/1131693/bloodrop/Screenshot%202015-05-27%2014.28.22.png










# Supplemental
## Age effects in atomic bomb survivors
Data is from table 12D2 of the BEIR VII report. The estimated risk of cancer mortality following a 1 mSv exposure.

```{r}
library(ggplot2)
library(scales)
ggsave_for_publication <- function(name, graph, width=7.2, height=5.4, ...) {
  suppressWarnings(ggsave(name,
                          graph,
                          dpi=600, 
                          width=width,   # < 7.5 in
                          height=height,  # < 8.75 in
                          units='in',
                          ...))
}
split <- function(x) as.numeric(strsplit(x, '\t')[[1]])

age <- 
  split("0	5	10	15	20	30	40	50	60	70	80")
cancer <- 
  split("1434.5	1099.5	908	758.5	636.5	461.5	442	414.5	364	283.5	171.5") 
cancer <- cancer * 10 / 100000  # convert risk per Sv to one individual

g <- ggplot(NULL, aes(age, cancer)) +
  geom_path(color='red', size=5, lineend="round") +
  scale_y_continuous(labels=percent, limits=c(0, 0.15)) + 
  ylab("Excess cancer mortality\n(% per Sv)") +
  xlab("Age at exposure\n(years)") +
  theme_bw() +
  theme(text = element_text(size=18))
g

ggsave_for_publication("age at exposure effects.png", g)
```






## Show models
```{r}
clean_theme <- function() {
  theme_bw() +
  theme(
    plot.background = element_blank()
   ,panel.grid.major = element_blank()
   ,panel.grid.minor = element_blank()
   ,panel.border = element_blank()
   ,axis.text.x = element_text(size = rel(2))
   ,axis.text.y = element_blank()
   ,axis.ticks = element_blank()
   ,axis.title = element_text(size = rel(2))
   ,plot.title = element_text(size = rel(2))
  ) +
  theme(axis.line = element_line(color = 'black'))
}
ggsave_for_publication <- function(name, graph, width=7.2, height=5.4, ...) {
  suppressWarnings(ggsave(name,
                          graph,
                          dpi=600, 
                          width=width,   # < 7.5 in
                          height=height,  # < 8.75 in
                          units='in',
                          ...))
}
dose <- function(to, from=0) seq(from, to, 0.01)

# BEIR VII model
g <- ggplot(NULL) +
  geom_smooth(method="lm", 
              formula="y ~ I(x^2) + x",
              aes(x=dose(1.5),
                  y=dose(1.5) + dose(1.5)^2),
              color="black",
              size=3) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(1.5),
                  y=dose(1.5)),
              color="red",
              size=3) +
  scale_x_continuous(breaks = c(0, 1.5), labels=c("0", "1.5 Gy")) +
  ylab("ERR") +
  xlab("dose") +
  ggtitle("BEIR VII's linear quadratic model") +
  clean_theme()
g
ggsave_for_publication("BEIR VII's linear quadratic model.png", g)

# My model
g <- ggplot(NULL) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(4),
                  y=dose(4) + dose(4)),
              color="black",
              size=3) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(4),
                  y=dose(4)),
              color="red",
              size=3) +
  geom_point(aes(x=0, y=0),
             size = 40,
             color="white") +
  geom_text(label = "?", 
            aes(x=0, y=0),
            size = 10,
            vjust=0.2) +
  scale_x_continuous(breaks = c(0, 4), labels=c("0", "4 Gy")) +
  ylab("ERR") +
  xlab("") +
  ggtitle("Linear-linear model") +
  clean_theme()
g
ggsave_for_publication("Our linear-linear model.png", g)


# Age adjustment
g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=exp(-1.73*dose(1))),
    color="black",
    size=3) +
  scale_x_continuous(breaks = c(0, 1), labels=c("young", "old")) +
  ylab("ERR per Sv") +
  xlab("") +
  ggtitle("Adjustment for age at exposure") +
  clean_theme()
g
ggsave_for_publication("Adjustment for age at exposure.png", g)


# Adaptive effects hypothesis
g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=dose(1)),
    color="black",
    size=3) +
  geom_path(  
    aes(x=seq(0, 1, 0.01),
        y=c(seq(0, 0.1, 0.01) * 1, 0.1 + seq(0.11, 1, 0.01) * 0.1)),
    color="red",
    size=3) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Adaptive effects") +
  clean_theme()
g
ggsave_for_publication("Adaptive effects hypothesis.png", g)


# Threshold hypothesis
response <- c(rep(0, 10), 
              seq(0, 0.9, 0.01) * 1)

protracted <- c(
  rep(0.0, 10),
  seq(0.00, 0.1, 0.01) * 1 + 0,
  rep(0.1, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.1,
  rep(0.2, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.2,
  rep(0.3, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.3,
  rep(0.4, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.4
)

g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=response),
    color="black",
    size=3) +
  geom_path(  
    aes(x=dose(1),
        y=protracted),
    color="red",
    size=3) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Threshold") +
  clean_theme()
g
ggsave_for_publication("Threshold hypothesis.png", g)


# Unknown hypothesis

g <- ggplot(NULL) +
  geom_text(aes(x=0.5, y=0.5, label="?"), size=100) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Something else") +
  clean_theme()
g
ggsave_for_publication("Unknown hypothesis.png", g)



```


## Why an exponential model is different.

The problem with the exponential model is that it weights low dose response data higher than high dose response data. We can prove that pretty easily.

```{r}
low_response_dref  <- 20
high_response_dref <- 10

low_response <- 50
high_response <- 20

n <- 2000
data <- ldply(1:n, function(i){
  data.frame(
    response=c(
      low_response + rnorm(1, 0, 0.01),
      high_response + rnorm(1, 0, 0.01),
      low_response / low_response_dref + rnorm(1, 0, 0.01),
      high_response / high_response_dref + rnorm(1, 0, 0.01)
    ),
    strata = c(1, 0, 1, 0),
    protracted = c(0, 0, 1, 1)
  )
})

model <- lm(log(response) ~ protracted + factor(strata), data=data)
summary(model)
```

I find that we end up with a ddref estimate that is the geometric mean of the values seen in each individual strata. This means if we have estimates of 10 and 1 we will get a final estimate of 10^0.5, about 3. So basically we will probably under-estimate DDREF by this approach.
