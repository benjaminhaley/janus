---
title: "Radiation fast and slow"
author: "Benjamin Haley"
date: "March 30, 2015"
output:
  html_document:
    css: /Users/benjaminhaley/Dropbox/Public/rmarkdown.css
---

## Is acute radiation most dangerous?

I will look at animal survival data and ask two central questions:

1. Are low dose-rate exposures safer than high dose-rate exposures?
2. Are fractionated exposures safer than acute exposures?

```{r echo=FALSE, message=FALSE}
# Libraries
library(plyr)
library(dplyr)
library(ggplot2)
library(scales)

# Helpers

# Retrieve the one unique value of x,
# raise an error if x has more than one value
only <- function(x) { 
  u <- unique(x)
  n <- length(u)
  if(n > 1) stop(paste("More than one value", paste(head(u), collapse=', ')))
  u
}
renumber <- function(the_data) {
  # Renumber clusters now that some are gone
  the_data %>%
    group_by(study) %>%
    mutate(cluster_number = reorder(cluster_number)) %>%
    ungroup()
}
show_survival <- function(the_data) {
  # Calculate survival
  the_data <- the_data %>%
    group_by(study, dose, group) %>%
    arrange(lifespan) %>%
    mutate(survival=rank(-lifespan) / length(lifespan))
  
  # Organize strata by number of animals
  order <- the_data %>% 
    group_by(stratum) %>%
    summarize(n=length(stratum)) %>%
    arrange(-n) %>%
    select(stratum)
  the_data$stratum <- factor(the_data$stratum, levels=order$stratum)
  
  # Show survival
  ggplot(the_data,
         aes(lifespan,
             survival,
             color=dose,
             group=group)) +
    geom_rect(
      aes(xmin=first,
          xmax=last,
          ymin=0,
          ymax=1),
      color="black"
    ) +
    geom_path() +
    facet_wrap(~ stratum, scales="free_x") +
    scale_color_continuous(
      guide = guide_legend(title = "dose (Gy)"),
      trans = "sqrt"
    ) +
    expand_limits(x = -4) +
    theme(text = element_text(size = 10)) +
    xlab("age (days)")
}

# Re-number the clusters to account for any filtered out
# reorder(c(2, 2, 4, 4)) == c(1, 1, 2, 2)
reorder <- function(x) {
  unique <- sort(unique(x), decreasing=FALSE)
  original <- unique
  new_value <- rank(unique)
  for(i in 1:length(original)) {
    x[x == original[i]] <- new_value[i]
  }
  x
}

# The number of distinct values not equal to na
# n_unique_values(c(0, 0, NA)) == 1
n_unique_values <- function(x) length(unique(x)[!is.na(unique(x))])

# Data
setwd('~/janus')
the_data <- readRDS('data/thesis.rds')
controls <- readRDS('data/thesis_controls.rds')
```


## Filter Data

I will look at data that is comparable to atomic bomb survivor data. Exposures less than 4 Gy to low-LET radiation.

```{r}
# Filter
the_data <- the_data %>%
  filter(dose <= 4)

# Censor animals that died before the final treatment in thier stratum
treatment_span <- the_data %>%
  group_by(stratum) %>%
  summarize(first = min(treatment_age, na.rm=TRUE),
            last = max(last_treatment_age, na.rm=TRUE))
the_data <- merge(the_data, treatment_span, by="stratum")
nrow(the_data) # 20157
the_data <- the_data %>%
  filter(lifespan > last)
nrow(the_data) # 20001
the_data <- renumber(the_data)

show_survival(the_data)
```

Note the awefulness in 9-4, 9-6, and 9-7! What if we filter their acute deaths out?

```{r}
# WARNING THIS REQUIRES JUSTIFICATION!!!!! #
# I think I should just base things on atomic bomb surivivors who
# were not monitored until 5 years after the initial exposure
# (~ 5% of lifespan, 50 days in mice)

# Censor animals in 9-4, 9-6, and 9-7 because they look so damn bad
nrow(the_data) # 21625
the_data <- the_data %>%
  filter(lifespan > 300)
nrow(the_data) # 21157
the_data <- renumber(the_data)

show_survival(the_data)
```

Looks much better!

## Inverse lifespan
Lets try beir VII's presentation

```{r}
# Mean Lifespans
aggregate = the_data %>%
  ungroup() %>%
  group_by(study,
           stratum,
           cluster_number,
           cluster,
           group,
           sex, 
           dose, 
           rate, 
           fractions,
           interval) %>%
  summarize(
    avg_treatment_age = mean((last_treatment_age + treatment_age)/2),
    treatment_age = mean(treatment_age),
    last_treatment_age = mean(last_treatment_age),
    n=length(lifespan),
    sem=sd(lifespan)/n^0.5,
    lifespan=mean(lifespan)
  )

# Add clusters to facet labels
aggregate <- ddply(aggregate, .(stratum), function(df) {
  number <- df$cluster_number[!is.na(df$cluster_number)]
  cluster <- df$cluster[!is.na(df$cluster)]
  clusters <- paste0(
    "     ",
    unique(number), ". ",
    unique(cluster),
    collapse="\n")
  df$stratum_full_name <- paste0(
    "  ", 
    df$stratum, 
    "\n",
    clusters
  )
  
  df
})

# Add controls to each cluster
aggregate <- ddply(aggregate, .(stratum, cluster), function(df) {

  # Look for a control exactly matches to the cluster
  control <- controls %>% 
    filter(stratum %in% only(df$stratum),
           cluster %in% only(df$cluster))
  
  # If that can't be found, look for a match to the whole stratum
  if(nrow(control) == 0) {
    control <- controls %>% 
      filter(stratum %in% only(df$stratum))
  }
  
  # Find the control in the aggregate data
  control <- aggregate %>% 
    filter(as.character(study) == only(control$study),
           as.character(group) %in% control$group)
  
  # Add the control to the cluster
  control$cluster <- only(df$cluster)
  control$stratum <- only(df$stratum)
  control$fractions <- mean(df$fractions)
  control$rate <- mean(df$rate)
  control$treatment_age <- mean(df$treatment_age)
  control$last_treatment_age <- mean(df$last_treatment_age)
  control$avg_treatment_age <- mean(df$avg_treatment_age)
  control$stratum_full_name <- only(df$stratum_full_name)
  control$cluster_number <- only(df$cluster_number)
  df <- rbind(df, control)
  
  df
})

# Remove groups that aren't a part of a cluster
# (this can happen if controls were not put in a specific cluster)
aggregate <- aggregate %>%
  filter(!is.na(cluster))

# Remove clusters that are only controls
# (this can happen if controls were not put in a specific cluster)
aggregate <- ddply(aggregate, .(stratum, cluster), function(df){
  if(all(df$dose == 0)) { return(NULL) }
  
  df
})

# Scale to control lifespans
aggregate <- ddply(aggregate, .(stratum, cluster), function(df){
  control_lifespan = only(df$lifespan[df$dose == 0])
  scale <- function(x) x / control_lifespan
  df <- df %>%
    mutate(lifespan = scale(lifespan),
           avg_treatment_age = scale(avg_treatment_age),
           treatment_age = scale(treatment_age),
           last_treatment_age = scale(last_treatment_age),
           sem = scale(sem)
           )

  df
})

# Make relative
# Factors like rate, # of fractions, and age at exposure should
# be available as relative values as well.
aggregate <- ddply(aggregate, .(stratum), function(df) {
  df <- df %>%
    mutate(relative_rate = rate / max(rate),
           fractionation = 1 / fractions,
           relative_fractionation = max(fractionation) - fractionation,
           relative_age = avg_treatment_age - min(avg_treatment_age))

  df
})

# Organize strata by number of animals
order <- aggregate %>% 
  group_by(stratum_full_name) %>%
  summarize(n=sum(n)) %>%
  arrange(-n) %>%
  select(stratum_full_name)
aggregate$stratum_full_name <- factor(
  aggregate$stratum_full_name, 
  levels=order$stratum_full_name
)

# Add predictions
model <- lm(lifespan ~ stratum * cluster * dose -
              stratum * cluster +
              stratum,
            weights=1/(sem)^2,
            aggregate)
aggregate$prediction <- predict(model)

# Unique id for each stratum
aggregate <- aggregate %>%
  mutate(stratum_id = paste(stratum, cluster))

## Overall graph
ggplot(aggregate,
       aes(dose,
           lifespan,
           label=cluster_number,
           group=cluster,
           color=cluster_number == 1)) +
  geom_text() +
  geom_smooth(method="lm", formula="y ~ x", se=FALSE) +
  facet_wrap(~ stratum_full_name) +
  theme(text = element_text(size = 10)) +
  xlab("dose (Gy)") +
  xlab("lifespan (relative to controls)") +
  scale_color_manual(values=c("black", "red"))
```


Overall the acute exposures are more dangerous. But the effect is by no means clean.


## Log link
```{r}

# Relative
aggregate <- ddply(aggregate, .(stratum), function(df) {
  df %>%
    mutate(
      age             = avg_treatment_age,
      age_log         = log(age + 0.1),
      age_log_diff    = age_log - min(age_log),

      fractionation   = 1 - 1/fractions,
      fractionation_diff = fractionation - min(fractionation),
      
      rate_log        = log(rate),
      rate_log_diff   = rate_log - min(rate_log)
    )
})


formulas <- c(
  "log(lifespan) ~ 1",
  "log(lifespan) ~ dose - 1",
  "log(lifespan) ~ dose * age_log - dose - age_log - 1",
  "log(lifespan) ~ dose * fractionation - dose - fractionation - 1",
  "log(lifespan) ~ dose * rate_log - dose - rate_log - 1",
  "log(lifespan) ~ dose * stratum - dose - stratum - 1",
  "log(lifespan) ~ dose * stratum + dose * age_log - stratum - dose - age_log - 1",
  "log(lifespan) ~ dose * stratum + dose * fractionation - stratum - dose - fractionation - 1",
  "log(lifespan) ~ dose * stratum + dose * rate_log - stratum - dose - rate_log - 1",
  "log(lifespan) ~ dose * stratum + dose * rate_log - stratum - dose - rate_log - 1"
)

model <- function(formula) {
  lm(formula,
     aggregate,
     weights = 1 / (sem + 0.01)^2)
}

ldply(formulas, function(formula) {
  fit <- model(formula)
  c(formula=formula, 
    aic=round(AIC(fit), 1),
    bic=round(BIC(fit), 1)
  )
}) %>%
  arrange(aic)


fit <- model(log(lifespan) ~ dose + stratum + age_log_diff + fractionation_diff - 1)
my_summary <- function(fit) {
  coefficients <- data.frame(summary(fit)$coefficients)
  coefficients <- coefficients[!grepl("stratum", rownames(coefficients)),]
  coefficients$variable <- rownames(coefficients)
  coefficients <- coefficients %>%
    mutate(multiplier = exp(Estimate),
           lower = exp(Estimate - 1.96 * Std..Error),
           upper = exp(Estimate + 1.96 * Std..Error),
           p = round(Pr...t.., 3)) %>%
    select(variable, multiplier, lower, upper, p)
  coefficients
}

summary(model(log(lifespan) ~ dose * stratum + dose * fractionation - stratum - dose - fractionation - 1))

```

























## Dose response

```{r}
tau <- 0.01

# Find the dose response for each cluster
dose_response <- ddply(aggregate, .(cluster, stratum), function(df) {
  control = df %>% filter(dose == 0)
  dose_response <- df %>% 
    mutate(
      dose_response = (only(control$lifespan) - lifespan) / dose,
      age = avg_treatment_age,
      fractionation = 1 - 1/fractions,
      sem = ((control$sem^2 + sem^2)^0.5)/dose + tau
    ) %>%
    select(dose_response, dose, rate, age, fractionation, sem) %>%
    filter(dose > 0)
  dose_response
})

# Which stratum have comparisons?
dose_response <- ddply(dose_response, .(stratum), function(df) {
  multiple <- function(x) length(unique(x)) > 1
  df$rate_comparison <- multiple(df$rate)
  df$fraction_comparison <- multiple(df$fraction)
  df$age_comparison <- multiple(round(df$age*20))
  df
})

# Relative
dose_response <- ddply(dose_response, .(stratum), function(df) {
  df %>%
    mutate(
      age_log         = log(age + 0.1),
      age_log_diff    = age_log - min(age_log),

      fractionation_diff = fractionation - min(fractionation),
      
      rate_log        = log(rate),
      rate_log_diff   = rate_log - min(rate_log)
    )
}) %>% 
  select(-age, -rate)

```


## show
```{r}
library(reshape2)
g <- melt(dose_response, id.vars = c("cluster", 
                                     "stratum", 
                                     "dose_response",
                                     "dose",
                                     "sem",
                                     "rate_comparison",
                                     "fraction_comparison",
                                     "age_comparison"
                                     )) %>%
  mutate(relative = grepl("_diff", variable),
         variable = sub("_diff", "", variable))

# Make predictions
to_predict <- ddply(g, .(variable, relative), function(df) {
  low <- df %>% mutate(value = min(value))
  high <- df %>% mutate(value = max(value))
  rbind(low, high)
})
model <- lm(dose_response ~ variable * value * relative -
              variable * value -
              variable * relative -
              value * relative +
              stratum, 
            g,
            weights = 1 / sem^2)
to_predict$prediction <- predict(model, to_predict)
summary(model)

ggplot(g, aes(value, dose_response)) + 
  geom_smooth(data=to_predict,
              aes(value, prediction),
              method="lm", 
              formula="y ~ x",
              color='white',
              size=4,
              se=FALSE) +
  geom_linerange(
    aes(ymin=dose_response - sem * 1.96, 
        ymax = dose_response + sem * 1.96,
        size=1/sem),
        color='grey'
    ) +
  geom_point() +
  facet_wrap(relative ~ variable, scales="free_x") +
  scale_y_continuous(labels=percent) +
  scale_size(range=c(0, 6), guide=FALSE) +
  coord_cartesian(ylim=c(-0.10, 0.25))
```

What is quite surprising about this data is that dose response is relatively stable all of the time, given that we account for the per-stratum effects. I suspect that they, in essence, mask the true dose response which is, in fact fairly stable across all animals.

## models

```{r}

formulas <- c(
  "log(dose_response) ~ 1",
  "log(dose_response) ~ age_log",
  "log(dose_response) ~ fractionation",
  "log(dose_response) ~ rate_log",
  "log(dose_response) ~ age_log_diff",
  "log(dose_response) ~ fractionation_diff",
  "log(dose_response) ~ rate_log_diff",
  "log(dose_response) ~ stratum",
  "log(dose_response) ~ I(dose_response)",
  "log(dose_response) ~ stratum + age_log_diff",
  "log(dose_response) ~ stratum + fractionation_diff",
  "log(dose_response) ~ stratum + rate_log_diff",
  "log(dose_response) ~ stratum + age_log_diff + fractionation_diff",
  "log(dose_response) ~ stratum + age_log_diff + rate_log_diff",
  "log(dose_response) ~ stratum + rate_log_diff + fractionation_diff",
  "log(dose_response) ~ stratum + rate_log_diff + fractionation_diff + age_log_diff",
  "log(dose_response) ~ stratum + age_log",
  "log(dose_response) ~ stratum + fractionation",
  "log(dose_response) ~ stratum + rate_log",
  "log(dose_response) ~ stratum + age_log + fractionation",
  "log(dose_response) ~ stratum + age_log + rate_log",
  "log(dose_response) ~ stratum + rate_log + fractionation",
  "log(dose_response) ~ stratum + rate_log + fractionation + age_log"
)

model <- function(formula) {
  lm(formula,
     dose_response,
     weights = 1 / sem^2)
}

ldply(formulas, function(formula) {
  fit <- model(formula)
  c(formula=formula, 
    aic=round(AIC(fit), 1),
    bic=round(BIC(fit), 1)
  )
}) %>%
  arrange(aic)

summary(model(dose_response ~ stratum + fractionation_diff))
summary(model(dose_response ~ 1))

acute <- rnorm(1000, 0.063775, 0.018229) 
/ rnorm(1000, -0.031005, 0.009431)
```

# Fractionation and stratum matter
According to AIC the best model is one that includes stratum and fractionation (or fractionation_diff). Log age almost makes the cut, but it is not quite significant.


*Things I have checked*
I worry about all sorts of random stuff. Here are things I worried about, but seem fine:

- [x] Make sure none of the aggregates look like duplicates.

*To Try*  
- Rerun the analysis without 9-4, 9-6, and 9-7 ![][1] (and anything else that shows signs of acute death)
- Use only one gender at a time
- Remove any animals that died before the age at last treatment (if there are any this is a good justification for using individual level data)
- Add interval information for acute exposures (the total length of their exposure)
- Use log(age) instead of age (because it behaves better)

[1]: http://dl.dropbox.com/u/1131693/bloodrop/Screenshot%202015-05-27%2014.28.22.png