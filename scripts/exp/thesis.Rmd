---
title: "Radiation fast and slow"
author: "Benjamin Haley"
date: "March 30, 2015"
output:
  html_document:
    css: /Users/benjaminhaley/Dropbox/Public/rmarkdown.css
---

## Is acute radiation most dangerous?

I will look at animal survival data and ask two central questions:

1. Are low dose-rate exposures safer than high dose-rate exposures?
2. Are fractionated exposures safer than acute exposures?

```{r echo=FALSE, message=FALSE}
setwd('~/janus')
source('scripts/util/thesis.R') # http://goo.gl/VYzkAs

# Data
setwd('~/janus')
original_data <- readRDS('data/thesis.rds')
controls <- readRDS('data/thesis_controls.rds')
```

## Dose response
Show dose response by group.

```{r}
basic_analysis <- function(name, dose_limit=4, exclude=c(), censor=0.0) {
  ## Get data
  data <- get_data(dose_limit = dose_limit, exclude=exclude, censor=censor)
  aggregated <- aggregate(data)
  
  # Find dose response by cluster
  dose_response <- get_dose_response_by_cluster(aggregated)
  by_cluster <- aggregate_by_cluster(aggregated)
  by_cluster <- merge(by_cluster, dose_response)
  
  # Show survival
  g <- show_survival(data); print(g)
  ggsave_for_publication(paste(name, "survival.png"), g)
  
  # Show overall effect
  g <- show_overall_dose_response(by_cluster); print(g)
  ggsave_for_publication(paste(name, "overall.png"), g)
  
  # Model
  model <- model_response(by_cluster)
  by_cluster <- add_predictions(by_cluster, model)
  aggregated <- add_cluster_predictions_to_aggregated(by_cluster, aggregated)
  g <- show_aggregated(aggregated); print(g)
  ggsave_for_publication(paste(name, "by cluster.png"), g)
  
  # Report the results
  coefficients <- get_coefficients(model)
  report_the_effects_of_age_and_fractionation(coefficients)
}


basic_analysis("basic 1 - 4 Sv", dose_limit = 4)
# fractionation: 
# 2.7 (1.6, 4.5)
# 
# age: 
# 0.7 (0.7, 0.8)


basic_analysis("basic 1 - 3 Sv", dose_limit = 3)
# fractionation: 
# 9.7 (2.3, 40.2)
# 
# age: 
# 0.6 (0.4, 0.7)

basic_analysis("basic 1 - 4 Sv exclude weird strata", 
               dose_limit = 4,
               stratum_with_weird_survivals)
# fractionation: 
# 2.8 (1.6, 5)
# 
# age: 
# 0.7 (0.6, 0.8)


basic_analysis("basic 1 - 4 Sv censor 5 years", 
               dose_limit = 4, 
               censor=5/75)
# fractionation: 
# 3.5 (2.1, 5.8)
# 
# age: 
# 0.6 (0.5, 0.6)


basic_analysis("basic 1 - 4 Sv censor 10 years", 
               dose_limit = 4, 
               censor=10/75)
# fractionation: 
# 2.6 (1.8, 3.6)
# 
# age: 
# 0.9 (0.8, 1)

basic_analysis("basic 1 - 4 Sv censor 20 years", 
               dose_limit = 4, 
               censor=20/75)
# fractionation: 
# 2.5 (1.6, 3.8)
# 
# age: 
# 1.1 (1, 1.3)

```

From these plots we can see that both age and fractionation matter. The effects of fractionation reduce risk by 1.6 fold or more, signficantly higher than BEIR VII's 1.5 estimate. 

Reassuringly mortality descreases with average age at exposure with an effect shockingly similar to the decrease in atomic bomb survivors. Concretely the risk reduces by 10-20% for every 13% that animals age (13% is a decade for a human that lives 75 years). The risk of solid cancer development in atomic bomb survivors drops by 10-30% per decade and a decade. These are remarkably similar estimates!

```{r}
# TODO: Used ln(age) to model dose response. It fits much better.
```



*Things I have checked*
I worry about all sorts of random stuff. Here are things I worried about, but seem fine:

- [x] Make sure none of the aggregates look like duplicates.

*To Try*  
- Rerun the analysis without 9-4, 9-6, and 9-7 ![][1] (and anything else that shows signs of acute death)
- Use only one gender at a time
- 

[1]: http://dl.dropbox.com/u/1131693/bloodrop/Screenshot%202015-05-27%2014.28.22.png










# Supplemental
## Age effects in atomic bomb survivors
Data is from table 12D2 of the BEIR VII report. The estimated risk of cancer mortality following a 1 mSv exposure.

```{r}
library(ggplot2)
library(scales)
ggsave_for_publication <- function(name, graph, width=7.2, height=5.4, ...) {
  suppressWarnings(ggsave(name,
                          graph,
                          dpi=600, 
                          width=width,   # < 7.5 in
                          height=height,  # < 8.75 in
                          units='in',
                          ...))
}
split <- function(x) as.numeric(strsplit(x, '\t')[[1]])

age <- 
  split("0	5	10	15	20	30	40	50	60	70	80")
cancer <- 
  split("1434.5	1099.5	908	758.5	636.5	461.5	442	414.5	364	283.5	171.5") 
cancer <- cancer * 10 / 100000  # convert risk per Sv to one individual

g <- ggplot(NULL, aes(age, cancer)) +
  geom_path(color='red', size=5, lineend="round") +
  scale_y_continuous(labels=percent, limits=c(0, 0.15)) + 
  ylab("Excess cancer mortality\n(% per Sv)") +
  xlab("Age at exposure\n(years)") +
  theme_bw() +
  theme(text = element_text(size=18))
g

ggsave_for_publication("age at exposure effects.png", g)
```






## Show models
```{r}
clean_theme <- function() {
  theme_bw() +
  theme(
    plot.background = element_blank()
   ,panel.grid.major = element_blank()
   ,panel.grid.minor = element_blank()
   ,panel.border = element_blank()
   ,axis.text.x = element_text(size = rel(2))
   ,axis.text.y = element_blank()
   ,axis.ticks = element_blank()
   ,axis.title = element_text(size = rel(2))
   ,plot.title = element_text(size = rel(2))
  ) +
  theme(axis.line = element_line(color = 'black'))
}
ggsave_for_publication <- function(name, graph, width=7.2, height=5.4, ...) {
  suppressWarnings(ggsave(name,
                          graph,
                          dpi=600, 
                          width=width,   # < 7.5 in
                          height=height,  # < 8.75 in
                          units='in',
                          ...))
}
dose <- function(to, from=0) seq(from, to, 0.01)

# BEIR VII model
g <- ggplot(NULL) +
  geom_smooth(method="lm", 
              formula="y ~ I(x^2) + x",
              aes(x=dose(1.5),
                  y=dose(1.5) + dose(1.5)^2),
              color="black",
              size=3) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(1.5),
                  y=dose(1.5)),
              color="red",
              size=3) +
  scale_x_continuous(breaks = c(0, 1.5), labels=c("0", "1.5 Gy")) +
  ylab("ERR") +
  xlab("dose") +
  ggtitle("BEIR VII's linear quadratic model") +
  clean_theme()
g
ggsave_for_publication("BEIR VII's linear quadratic model.png", g)

# My model
g <- ggplot(NULL) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(4),
                  y=dose(4) + dose(4)),
              color="black",
              size=3) +
  geom_smooth(method="lm", 
              formula="y ~ x",
              aes(x=dose(4),
                  y=dose(4)),
              color="red",
              size=3) +
  geom_point(aes(x=0, y=0),
             size = 40,
             color="white") +
  geom_text(label = "?", 
            aes(x=0, y=0),
            size = 10,
            vjust=0.2) +
  scale_x_continuous(breaks = c(0, 4), labels=c("0", "4 Gy")) +
  ylab("ERR") +
  xlab("") +
  ggtitle("Linear-linear model") +
  clean_theme()
g
ggsave_for_publication("Our linear-linear model.png", g)


# Age adjustment
g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=exp(-1.73*dose(1))),
    color="black",
    size=3) +
  scale_x_continuous(breaks = c(0, 1), labels=c("young", "old")) +
  ylab("ERR per Sv") +
  xlab("") +
  ggtitle("Adjustment for age at exposure") +
  clean_theme()
g
ggsave_for_publication("Adjustment for age at exposure.png", g)


# Adaptive effects hypothesis
g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=dose(1)),
    color="black",
    size=3) +
  geom_path(  
    aes(x=seq(0, 1, 0.01),
        y=c(seq(0, 0.1, 0.01) * 1, 0.1 + seq(0.11, 1, 0.01) * 0.1)),
    color="red",
    size=3) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Adaptive effects") +
  clean_theme()
g
ggsave_for_publication("Adaptive effects hypothesis.png", g)


# Threshold hypothesis
response <- c(rep(0, 10), 
              seq(0, 0.9, 0.01) * 1)

protracted <- c(
  rep(0.0, 10),
  seq(0.00, 0.1, 0.01) * 1 + 0,
  rep(0.1, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.1,
  rep(0.2, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.2,
  rep(0.3, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.3,
  rep(0.4, 10),
  seq(0.01, 0.1, 0.01) * 1 + 0.4
)

g <- ggplot(NULL) +
  geom_path(  
    aes(x=dose(1),
        y=response),
    color="black",
    size=3) +
  geom_path(  
    aes(x=dose(1),
        y=protracted),
    color="red",
    size=3) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Threshold") +
  clean_theme()
g
ggsave_for_publication("Threshold hypothesis.png", g)


# Unknown hypothesis

g <- ggplot(NULL) +
  geom_text(aes(x=0.5, y=0.5, label="?"), size=100) +
  scale_x_continuous(
    breaks = c(), 
    labels=c()) +
  ylab("ERR per Sv") +
  xlab("dose") +
  ggtitle("Something else") +
  clean_theme()
g
ggsave_for_publication("Unknown hypothesis.png", g)



```


## Why an exponential model is different.

The problem with the exponential model is that it weights low dose response data higher than high dose response data. We can prove that pretty easily.

```{r}
low_response_dref  <- 20
high_response_dref <- 10

low_response <- 50
high_response <- 20

n <- 2000
data <- ldply(1:n, function(i){
  data.frame(
    response=c(
      low_response + rnorm(1, 0, 0.01),
      high_response + rnorm(1, 0, 0.01),
      low_response / low_response_dref + rnorm(1, 0, 0.01),
      high_response / high_response_dref + rnorm(1, 0, 0.01)
    ),
    strata = c(1, 0, 1, 0),
    protracted = c(0, 0, 1, 1)
  )
})

model <- lm(log(response) ~ protracted + factor(strata), data=data)
summary(model)
```

I find that we end up with a ddref estimate that is the geometric mean of the values seen in each individual strata. This means if we have estimates of 10 and 1 we will get a final estimate of 10^0.5, about 3. So basically we will probably under-estimate DDREF by this approach.


