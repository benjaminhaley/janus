---
title: "data.Rmd"
author: "Benjamin Haley"
date: "March 30, 2015"
output: html_document
---

Check and clean data for thesis.Rmd.

```{r}
# Libraries
library(plyr)
library(dplyr)

# Data
setwd('~/janus')
data <- readRDS('data/external5.rds')

# Helpers
get_cluster <- function(cluster_number) {
  map <- data %>% 
    filter(stratum == stratum_name) %>%
    select(cluster, cluster_number)
  map <- unique(map)
  map$cluster[match(cluster_number, map$cluster_number)]
}
fix <- function(group, column, value) {
  data[data$study == study & data$group %in% group, column] <- value
  data
}
split <- function(x, split=" ") strsplit(x, split)[[1]]
summary <- function(study_id) {
  data %>% 
    group_by(lab,
             study, 
             group, 
             species,
             strain,
             sex, 
             treatment_age,
             fractions, 
             interval,
             dose, 
             rate,
             quality,
             use,
             other_treatments) %>%
    summarize(n=length(lifespan),
              'age.u'=round(mean(lifespan)),
              'age.o'=round(sd(lifespan), 1),
              'age.u.o'=round(sd(lifespan) / n^0.5, 1),
              'median_age'=median(lifespan/365.25)
              ) %>%
    filter(study == study_id) %>%
    ungroup() %>%
    select(-study)
}
summary2 <- function(study_id) {
  data %>% 
    group_by(lab,
             study, 
             group, 
             species,
             strain,
             sex, 
             fractions, 
             interval,
             dose, 
             rate,
             quality,
             use,
             other_treatments) %>%
    summarize(n=length(lifespan),
              'treatment_age.u'=round(mean(treatment_age)),
              'age.u'=round(mean(lifespan)),
              'age.o'=round(sd(lifespan), 1),
              'age.u.o'=round(sd(lifespan) / n^0.5, 1),
              'median_age'=median(lifespan/365.25),
              'MAS'=round(mean(lifespan - treatment_age))
              ) %>%
    filter(study == study_id) %>%
    ungroup() %>%
    select(-study)
}
add_warning <- function(group, message) {
  subset <- 
    data$study == study & 
    (data$group %in% as.character(group))
  data[subset, 'warnings'] <- paste(
    data[subset, 'warnings'],
    message
  )
  data
}
use <- function(group, value=TRUE) {
  subset <- 
    data$study == study & 
    (data$group %in% as.character(group))
  data[subset, 'use'] <- value
  data
}
name_stratum <- function(group, name){
  data$stratum[data$study == study &
               data$group %in% as.character(group)] = name
  data
}
name_cluster <- function(group, number, name) {
  subset <- 
    data$study == study & 
    (data$group %in% as.character(group))
  data[subset, 'cluster'] <- name
  data[subset, 'cluster_number'] <- number
  data
}
controls <- data.frame()
controls_for <- function(group, stratum, cluster=NA) {
  group=as.character(group)
  new_mapping = data.frame(
    study, 
    group, 
    stratum, 
    cluster
  )
  controls = rbind(controls, new_mapping)
  controls
}


# Clean a little
data <- data %>%
  mutate(
    full_group_id = group_id,
    study = study_id,
    group = sub('[0-9]*-[x0-9]*-', '', group_id),
    group = ifelse(!is.na(tmt), as.character(tmt), group),
    rate = dose_rate,
    treatment_age = age_at_treatment,
    interval = fraction_interval,
    old_exclude = exclude,
    old_warning = warning,
    old_warning_reason = warning_reason
  )

aliases <- list(
  'quality'= c(
    'gamma-rays Co-60'='γ-ray',
    'gamma-rays Co-60, gamma-rays Co-60'='γ-ray',
    'gamma-rays Co-60, gamma-rays Co-60, gamma-rays Co-60'='γ-ray',
    'gamma-rays Cs-137'='γ-ray',
    'gamma-rays whole body'='γ-ray',
    'gamma-rays'='γ-ray',
    'X-rays whole body'='X-ray'
  ),
  'sex'= c(
    Both='♂/♀',
    Female='♀',
    Male='♂'
  ),
  'lab'= c(
    '2'='CEN-FAR',
    '3'='ENEA',
    '9'='SCK/CEN',
    '11'='TNO',
    '1002'='DAVIS',
    '1003'='ANL',
    '1005'='ITRI',
    '1007'='ORNL',
    '1008'='CSU'
  )
)

# Add lab
data$lab <- sub('(^[0-9]*).*$', '\\1', data$study)


# Assign aliases
# Replace all values in a given column with their aliases
# e.g. replace gamma-rays with γ
for(column in names(aliases)) {
  for(name in names(aliases[[column]])) {
    alias = aliases[[column]][name]
    data[data[column] == name & !is.na(data[column]),column] <- alias
  }
}

# Janus lumps male and female, gamma and neutron into the same group names. 
# Make the distinction clear.
janus_studies <- paste0('1003-', 20:29)
data <- data %>%
  mutate(
    quality_abbreviation = ifelse(quality == "γ-ray", "γ", ""),
    group = ifelse(study %in% janus_studies, 
                        paste0(group, sex, quality_abbreviation),
                        group)) %>%
  select(-quality_abbreviation)

####

# Final rinse

data <- data %>%
  select(
    study,
    lab,
    group,
    sex,
    species,
    strain,
    lifespan,
    treatment_age,
    quality,
    dose,
    rate,
    fractions,
    interval,
    other_treatments,
    old_exclude,
    old_warning,
    old_warning_reason) %>%
  mutate(
    use = NA,
    warnings = "",
    stratum = NA,
    cluster = NA,
    cluster_number = NA
)

####  

study <- "9-5"
summary(study) %>%
  filter(quality != 'neutrons>10 MeV') %>%
  select(-lab)
# source: 3575970.pdf

# fix
# 
stratum_name <- "9-5 SCK/CEN ♂ BALB/c/Cnb mice\n  γ-ray @84 days"
data <- name_stratum(1:13, stratum_name)
data <- name_cluster(2:7, 1, "acute 4 Gy/min")
data <- name_cluster(8:13, 2, "10 over 10 days 4 Gy/min")
controls <- controls_for(1, stratum_name)

data <- add_warning(
  group = 2,
  message = "Mean lifespan in 3575970.pdf is 743 vs. 738 in mine.")
data <- add_warning(
  group = 2,
  message = "Mean lifespan in 3575970.pdf is 747 vs. 739 in mine."
)
data <- add_warning(
  group = 1:13,
  message = "SE of mean lifespan reported in in 3575970.pdf are about 4x higher than in mine."
)
data <- use(group=1:13)

# check
#   [x] species
#   [x] strain
#   [x] fractions
#   [x] interval
#   [x] treatment_age
#   [x] sex
#   [x] n
#   [x] u(age) 
#        - group 2 is 743 in the source, 738 in mine
#        - group 10 is 747 in the source, 739 in mine
#   [x] o(age)
#        - they are all about 4x higher than mine with no discernable pattern
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] use
#   [x] study name
#   [x] cluster names



####

study <- "9-6"
summary(study) %>%
  filter(quality != "neutrons>10 MeV") %>% 
  print(n=100)
# source 3577205.pdf


# fix
# 
stratum_name <- "9-6 SCK/CEN ♂ C57BL/Cnb mice\n  γ-ray @84 days"
data <- name_stratum(1:16, stratum_name)
data <- name_cluster(2:7, 1, "acute 0.3 Gy/min")
data <- name_cluster(14:16, 2, "8 over 1 day 0.3 Gy/min")
data <- name_cluster(8:13, 3, "10 over 10 days 0.3 Gy/min")
controls <- controls_for(1, stratum_name)

data <- add_warning(
  group = 1:13,
  message = "SE of mean lifespan reported in in 3577205.pdf are about 4x higher than in mine (just like 9-5)."
)
data <- use(group=1:16)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] study name
#   [x] group names


####

study <- "2-10"

# Will not use, all the doses are greater than 6 Gy
# according to Gerber 1995


####

study <- "2-11"
TODO

# Will not use, all the doses are similarly protracted
# accoriding to Gerber 1995


####

study <- "7-8"

# Will not use, not archived in the ERA :(



####

study <- "9-4"
summary(study) %>%
  # C57BL/Cnb is the only strain which compares fractionated
  # and acute exposures. BALB/c/Cnb is only acute.
  filter(other_treatments == "none",
         strain == "C57BL/Cnb") %>% 
  select(-treatment_age, -other_treatments) %>%
  print(n=100)
# source 3575315.pdf


# fix
# 
stratum_name <- "9-4 SCK/CEN ♂ C57BL/Cnb mice\n  X-ray @28 days"
stratum_groups <- c(24:26, 29:31, 33:35)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(25:26, 1, "acute")
data <- name_cluster(c(29:31, 33:35), 2, "4 over 28 days 0.94 Gy/min")
controls <- controls_for(24, stratum_name)

# They labeled the interval (1 week) in minutes (10080)
# But I want it to be in days (7)
data$interval[data$study == "9-4" & data$interval == 10080] <- 7
data <- add_warning(
  group = stratum_groups,
  message = "The standard errors reported in 3575315.pdf are regularly ~4x larger than the stardard errors I measure in the data"
)
data <- use(stratum_groups)


# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#       The standard errors reported in 3575315.pdf are regularly
#       ~4x larger than the stardard errors I measure in the data
#   [x] use
#   [x] study name
#   [x] group names



#### 11-2 A

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local'),
         other_treatments %in% c('none'),
         group %in% 1:3) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-A TNO ♀ WAG/RIJ rats\n  X-ray @56 days"
stratum_groups <- c(1:3)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(2, 1, "acute 0.06 Gy/min")
data <- name_cluster(3, 2, "five over 153 days 0.06 Gy/min")
controls <- controls_for(1, stratum_name)

# fix
data$interval[data$study == study & data$group == 3] <- 7*4
data <- use(stratum_groups)


# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


### 11-2 B - xray

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local'),
         other_treatments %in% c('none'),
         group %in% c(7:11, 13, 14)) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  arrange(as.numeric(group)) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# warn
data <- add_warning(13, "Does not align with Gerber 1996 group 13. Appears to be group 12 in that report and was treated with 2 Gy, not 1 Gy as indicated by the table.")
data <- add_warning(14, "Does not align with Gerber 1996 group 14. Appears to be group 13 in that report.")

# define
stratum_name <- "11-2-B TNO ♀ WAG/RIJ rats\n  X-ray @56 days"
stratum_groups <- c(7:11, 13:14)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(10), 1, "acute 0.06 Gy/min")
data <- name_cluster(c(8:9, 11), 2, "10 over 305 days 0.06 Gy/min")
data <- name_cluster(13, 3, "20 over 70 days 0.06 Gy/min")
data <- name_cluster(14, 4, "10 over 14 days 0.06 Gy/min")
controls <- controls_for(7, stratum_name)
data <- use(stratum_groups)

@here

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


### 11-2 B - γ-ray

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local'),
         other_treatments %in% c('none'),
         group %in% 7:19) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# warn
# define
stratum_name <- "11-2-B TNO ♀ WAG/RIJ rats\n  γ-ray @56 days"
stratum_groups <- c(7, 16:19)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(16, 1, "acute 0.9 Gy/min")
data <- name_cluster(17, 2, "10 over 305 days 0.001 Gy/min")
data <- name_cluster(18, 3, "20 over 70 days 0.001 Gy/min")
data <- name_cluster(19, 4, "10 over 14 days 0.001 Gy/min")
controls <- controls_for(7, stratum_name)
data <- use(stratum_groups)

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



### 11-2 D - γ-ray @56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group > 30 & group < 45
         ,treatment_age != 117 | is.na(treatment_age)
         ) %>% 
  #  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)


# define
stratum_name <- "11-2-D TNO ♀ WAG/RIJ rats\n  γ-ray @56 days"
stratum_groups <- c(31, 34, 38, 40)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(34, 40), 1, "acute 0.9 Gy/min")
data <- name_cluster(c(38), 2, "120 over 12 days 0.001 Gy/min")
controls <- controls_for(31, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at treatment or age at death")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings





### 11-2 D - γ-ray 117 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group > 30 & group < 45
         ,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
  #  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-D TNO ♀ WAG/RIJ rats\n  γ-ray @117 days"
stratum_groups <- c(31, 36, 42, 44)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(36, 42), 1, "acute 0.9 Gy/min")
data <- name_cluster(c(44), 2, "120 over 12 days 0.001 Gy/min")
controls <- controls_for(31, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at treatment or age at death")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




### 11-2 E - WAG/RIJ X-ray 56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group %in% c(49:78)
         ,strain == "WAG/RIJ"
         #,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-E TNO ♀ WAG/RIJ rats\n  X-ray @56 days"
stratum_groups <- c(49, 61, 71, 77)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(61), 1, "acute 0.06 Gy/min")
data <- name_cluster(c(71, 77), 2, "10 over 70 days 0.06 Gy/min")
controls <- controls_for(49, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at death")
data <- add_warning(c(71, 77), "Could not confirm time between fractions")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [?] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




### 11-2 E - SD/RIJ X-ray 56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group %in% c(49:78)
         ,strain == "SD/RIJ"
         #,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
#  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-E TNO ♀ SD/RIJ rats\n  X-ray @56 days"
stratum_groups <- c(50, 62, 72, 78)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(62), 1, "acute 0.06 Gy/min")
data <- name_cluster(c(72, 78), 2, "10 over 70 days 0.06 Gy/min")
controls <- controls_for(50, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at death")
data <- add_warning(c(72, 78), "Could not confirm time between fractions")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [?] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




### 11-2 E - BN/BRIJ X-ray 56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group %in% c(49:78)
         ,strain == "BN/BRIJ"
         #,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-E TNO ♀ BN/BRIJ rats\n  X-ray @56 days"
stratum_groups <- c(51, 53:55, 57:59, 75)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(53:55, 57, 59, 75), 1, "acute 0.06 Gy/min ")
data <- name_cluster(c(58), 2, "5 over 35 days 0.06 Gy/min")
controls <- controls_for(51, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at death")
data <- add_warning(c(58), "Could not confirm time between fractions")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [?] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



### 11-2 F - WAG/RIJ X-ray 56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group %in% c(98:134)
         ,strain == "WAG/RIJ"
         #,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-F TNO ♀ WAG/RIJ rats\n  X-ray @56 days"
stratum_groups <- c(98, 102, 108, 110, 116, 118)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(102, 108, 116), 1, "acute 0.06 Gy/min")
data <- name_cluster(c(110, 118), 2, "20 over 28 days 0.06 Gy/min")
controls <- controls_for(98, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at death")
data <- add_warning(98, "Removed one animal with age at death 6993 (way too high)")

# fix
data <- data %>%
  filter(!(study == "11-2" &
           group == 98 &
           lifespan == 6993))

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



####


### 11-2 F - BN/BRIJ X-ray 56 days

study <- "11-2"
summary(study) %>%
  filter(!quality %in% c('accel. neutrons 0.1-10 MeV',
                         'neutrons 1-10 MeV',
                         'neutrons>10 MeV',
                         'X-rays local')
         ,other_treatments %in% c('none')
         ,group %in% c(98:134)
         ,strain == "BN/BRIJ"
         #,treatment_age != 56 | is.na(treatment_age)
         ) %>% 
  select(-lab, -sex, -strain, -treatment_age, -other_treatments) %>%
  print(n=100)

# sources
#  Broerse 1989 (doesn't have ages)
#  717898.pdf (also doesn't have ages)

# define
stratum_name <- "11-2-F TNO ♀ BN/BRIJ rats\n  X-ray @56 days"
stratum_groups <- c(99, 100, 104, 112, 114, 119, 121)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(c(100, 104, 112, 119), 1, "acute 0.06 Gy/min")
data <- name_cluster(c(114, 121), 2, "20 over 28 days 0.06 Gy/min")
controls <- controls_for(99, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(stratum_groups, "Could not confirm age at death")

# fix
data <- add_warning(99, "Removed one animal with age at death 6993 (way too high)")

# fix
data <- data %>%
  filter(!(study == "11-2" &
           group == 99 &
           lifespan == 6993))

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [?] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [?] u(age) 
#   [?] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


####

study <- "13-4"

# Will not use (data is not the era)


####

study <- "13-15"

# Will not use (data is not the era)


####

study <- "13-17"

# Will not use (data is not the era)

####

study <- "13-22"

# Will not use (data is not the era)



####

#### WILL NOT USE ####
# This data cannot be aligned with the published literature 3572640.pdf
#
# I began the process noticing small errors and omissions, animal counts
# slightly different, missing dose rate definitions. But the real problem
# is that the ages of animals do not align closely. I looked at this
# for individual dogs in the control (which are listed in 3572640.pdf).
# I found many errors and omissions (though it is obvious that these are
# from the same study, because many are the same). See [1] for details
# of that comparison.
#
# [1]: lifespans from group 1 of beagles in study 1002-1.xlsx
# 
# study <- "1002-1"
# summary(study) %>%
# #  filter(TODO) %>% 
#   select(-lab, -species, -strain, -sex, -quality, -other_treatments) %>%
#   print(n=100)
# # source 3572640.pdf
# 
# 
# # define
# stratum_name <- "1002-F beagle dogs\n  ?? Gy/min X-ray @400 days"
# stratum_groups <- c(1:15)
# data <- name_stratum(stratum_groups, stratum_name)
# data <- name_cluster(groups_TODO, number_TODO, TODO)
# controls <- controls_for(group_TODO, stratum_name)
# #data <- use(stratum_groups)
# 
# # warn
# data <- add_warning(1, "Number of dogs is 56 in mine and 57 in 3572640.pdf table 1")
# data <- add_warning(8, "Number of dogs is 19 in mine and 23 in 3572640.pdf table 1")
# data <- add_warning(9, "Number of dogs is 21 in mine and 22 in 3572640.pdf table 1")
# data <- add_warning(11, "Number of dogs is 27 in mine and 26 in 3572640.pdf table 1")
# data <- add_warning(12, "Number of dogs is 23 in mine and 25 in 3572640.pdf table 1")
# data <- add_warning(14, "Number of dogs is 22 in mine and 23 in 3572640.pdf table 1")
# 
# 
# # fix
# # treatment_age
# #   "X-irradiation was performed when the beagles were 10 to 12 months of 
# #    age." - 3572640.pdf
# #    *Notably this is close to the time of puberty
# data[data$study == study, 'treatment_age'] <- 335.5
# # fractions
# #   Table 1, 3572640.pdf
# data[data$study == study & data$group %in%   2:4, 'fractions'] <- 4
# data[data$study == study & data$group %in%   5:7, 'fractions'] <- 2
# data[data$study == study & data$group %in%     8, 'fractions'] <- 1
# data[data$study == study & data$group %in%  9:11, 'fractions'] <- 4
# data[data$study == study & data$group %in% 12:14, 'fractions'] <- 2
# data[data$study == study & data$group %in%    15, 'fractions'] <- 1
# # interval
# #   Table 1, 3572640.pdf
# data[data$study == study & data$group %in% c(2, 5,  9, 12), 'interval'] <- 28
# data[data$study == study & data$group %in% c(3, 6, 10, 13), 'interval'] <- 14
# data[data$study == study & data$group %in% c(4, 7, 11, 14), 'interval'] <-  7
# # dose
# #   Table 1, 3572640.pdf
# #   R -> Gy
# data[data$study == study, 'dose'] <- data[data$study == study, 'dose'] / 100
# # dose rate
# #   "dose rate averaged 8.5 R/min"
# data[data$study == study, 'rate'] <- 8.5 / 100
# 
# # check
# #   [x] species
# #   [x] strain
# #   [x] sex
# #   [x] treatment_age
# #   [x] fractions
# #   [x] interval
# #   [x] dose
# #   [x] rate
# #   [x] quality
# #   [x] n

##### ABANDONED ######
# at this piont in the review I opted to reject this study. see reason above.


#### "1003-5" WILL NOT USE
#
# All of these argonne dogs recieved doses greater than 3 Gy.
# I found some problems with the data noted below in case I ever come
# back to this.
# 
# summary <- function(study_id) {
#   data %>% 
#     group_by(lab,
#              study, 
#              group, 
#              species,
#              strain,
# #             sex, 
# #             treatment_age,
# #             fractions, 
#              interval,
# #             dose, 
#              rate,
#              quality,
#              use,
#              other_treatments) %>%
#     summarize(n=length(lifespan),
#               'u(treatment_age)'=round(mean(treatment_age)),
#               'u(fractions)'=round(mean(fractions)),
#               'u(dose)'=round(mean(dose)),
#               'u(age)'=round(mean(lifespan)),
#               'o(age)'=round(sd(lifespan), 1),
#               'o(u(age))'=round(sd(lifespan) / n^0.5, 1),
#               'median_age'=median(lifespan/365.25)
#               ) %>%
#     filter(study == study_id) %>%
#     ungroup() %>%
#     select(-study)
# }
# 
# study <- "1003-5"
# summary(study) %>%
#   select(-species, -strain, -other_treatments) %>%
#   arrange(rate) %>%
#   mutate(rate = round(rate * 60*24*1000 / 1.17)) %>%
# #  filter(TODO) %>% 
#   print(n=100)
# # source 3578646.pdf
# 
# 4, 5, 6, 8 checks out n and lifespan
# 7, 9 do not
# 2 "2610 is different in mine (n = 39, lifespan = 3879) than in theirs (n = 46, lifespan = 3818)"
# 3 "2510 is different in mine (n = 44, lifespan = 3087) than in theirs (n = 46, lifespan = 3179)"
# 7 "2110 is different in mine (n = 8, lifespan = 705) than in theirs (n = 16, lifespan = 583)"
# 9 "5100 where rate is 503 mGy/day is different in mine (n = 8, lifespan = 442) than in theirs (n = 4, lifespan = 473)"
# 
# # stratum_name <- ""11-2-F TNO ♀ BN/BRIJ rats\n  0.06 Gy/min X-ray @56 days"
# # stratum_groups <- c(1:15)
# 
# # define
# stratum_name <- "1003-5 ANL beagle dogs\n  γ-ray"
# stratum_groups <- TODO
# data <- name_stratum(stratum_groups, stratum_name) # "+sex, + rate, +age"
# data <- name_cluster(groups_TODO, number_TODO, TODO)
# controls <- controls_for(group_TODO, stratum_name)
# data <- use(stratum_groups)
# 
# # warn
# data <- add_warning(stratum_groups, "could not validate number of animals by sex")
# 
# # fix
# 
# # check
# #   [x] species
# #   [x] strain
# #   [-] sex
# #   [ ] treatment_age
# #   [ ] fractions
# #   [ ] interval
# #   [ ] dose
# #   [ ] rate
# #   [ ] quality
# #   [ ] n
# #   [ ] u(age) 
# #   [ ] o(age)
# #   [ ] use
# #   [ ] stratum name
# #   [ ] cluster names
# #   [ ] defined controls
# #   [ ] added warnings


#### 1003-6
# 
# Will not use because all of the doses are greater than 4 Gy


#### Note: 
# 
# Include high doses if fractionated.
# From this point forward I will include studies with doses greater
# than 4 Gy, provided these high doses were fractoinated and they
# also include acute exposures that were 4 Gy or lower.

#### 1003-20 ♀ at 100 days
#
study <- "1003-20"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♀',
         treatment_age.u < 140) %>%
  select(-lab, -species, -strain, -sex, -quality, -median_age, -other_treatments, -use) %>%
  arrange(dose != 0, group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 7 & appendix J

# define
stratum_name <- "1003-20 ANL ♀ B6CF1 mice\n  γ-ray @110 days"
stratum_groups <- split("AC♀ AI♀γ BI♀γ DC♀ DI♀γ EC♀ EI♀γ HC♀ HI♀γ S0♀ S1♀γ S2♀γ S3♀γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split("S3♀γ"), 1, "acute 0.38 Gy/min")
data <- name_cluster(split("S2♀γ"), 2, "acute 0.13 Gy/min")
data <- name_cluster(split("S1♀γ"), 3, "acute 0.043 Gy/min")
data <- name_cluster(split("AI♀γ"), 4, "72 over 168 days 0.0076 Gy/min")
data <- name_cluster(split("BI♀γ"), 5, "24 over 168 days 0.0076 Gy/min")
data <- name_cluster(split("DI♀γ"), 6, "24 over 168 days 0.0099 Gy/min")
data <- name_cluster(split("EI♀γ"), 7, "24 over 168 days 0.00095 Gy/min")
data <- name_cluster(split("HI♀γ"), 8, "6 over 183 days 0.0076 Gy/min")

# controls
controls <- controls_for("S0♀", stratum_name, get_cluster(1))
controls <- controls_for("S0♀", stratum_name, get_cluster(2))
controls <- controls_for("S0♀", stratum_name, get_cluster(3))
controls <- controls_for("AC♀", stratum_name, get_cluster(4))
controls <- controls_for("AC♀", stratum_name, get_cluster(5))
controls <- controls_for("DC♀", stratum_name, get_cluster(6))
controls <- controls_for("EC♀", stratum_name, get_cluster(7))
controls <- controls_for("HC♀", stratum_name, get_cluster(8))
data <- use(stratum_groups)

# warn
data <- add_warning("HC♀", "MAS is 801 in my data, 816 in grahn 1995 Table 7")
data <- add_warning("AI♀γ", "MAS is 677 in my data, 690 in grahn 1995 Table 7")
data <- add_warning("BI♀γ", "MAS is 677 in my data, 673 in grahn 1995 Table 7")
data <- add_warning("EI♀γ", "MAS is 681 in my data, 687 in grahn 1995 Table 7")
data <- add_warning("HI♀γ", "MAS is 627 in my data, 641 in grahn 1995 Table 7")

# fix
data <- fix('AC♀', 'fractions', 72)
data <- fix('AC♀', 'interval', 7/3)
data <- fix('DC♀', 'fractions', 24)
data <- fix('DC♀', 'interval', 7)
data <- fix('EC♀', 'fractions', 24)
data <- fix('EC♀', 'interval', 7)
data <- fix('HC♀', 'fractions', 6)
data <- fix('HC♀', 'interval', 30.5)
data <- fix('AI♀γ', 'interval', 7/3)
data <- fix('BI♀γ', 'interval', 7)
data <- fix('EI♀γ', 'interval', 7)
data <- fix('HI♀γ', 'interval', 30.5)
data <- fix('DI♀γ', 'interval', 7)


# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




#### 1003-20 ♂ at 100 days
#
study <- "1003-20"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♂',
         treatment_age.u < 140) %>%
  select(-species, -strain, -sex, -quality, -other_treatments, -median_age) %>%
  arrange(dose != 0, group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 7 & appendix J

# define
stratum_name <- "1003-20 ANL ♂ B6CF1 mice\n  γ-ray @110 days"
stratum_groups <- split("AC♂ AI♂γ BI♂γ DC♂ DI♂γ EC♂ EI♂γ HC♂ HI♂γ S0♂ S1♂γ S2♂γ S3♂γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split("S3♂γ"), 1, "acute 0.38 Gy/min")
data <- name_cluster(split("S2♂γ"), 2, "acute 0.13 Gy/min")
data <- name_cluster(split("S1♂γ"), 3, "acute 0.043 Gy/min")
data <- name_cluster(split("AI♂γ"), 4, "72 over 168 days 0.0076 Gy/min")
data <- name_cluster(split("BI♂γ"), 5, "24 over 168 days 0.0076 Gy/min")
data <- name_cluster(split("DI♂γ"), 6, "24 over 168 days 0.0099 Gy/min")
data <- name_cluster(split("EI♂γ"), 7, "24 over 168 days 0.00095 Gy/min")
data <- name_cluster(split("HI♂γ"), 8, "6 over 183 days 0.0076 Gy/min")

# controls
controls <- controls_for("S0♂", stratum_name, get_cluster(1))
controls <- controls_for("S0♂", stratum_name, get_cluster(2))
controls <- controls_for("S0♂", stratum_name, get_cluster(3))
controls <- controls_for("AC♂", stratum_name, get_cluster(4))
controls <- controls_for("AC♂", stratum_name, get_cluster(5))
controls <- controls_for("DC♂", stratum_name, get_cluster(6))
controls <- controls_for("EC♂", stratum_name, get_cluster(7))
controls <- controls_for("HC♂", stratum_name, get_cluster(8))
data <- use(stratum_groups)

# warn
data <- add_warning("Z3♂", "number of mice 194 in my data, 199 in grahn 1995 Table 7")
data <- add_warning("HC♂", "MAS 808 in my data, 840 in grahn 1995 Table 7")
data <- add_warning("AI♂γ", "MAS 704 in my data, 711 in grahn 1995 Table 7")
data <- add_warning("BI♂γ", "MAS 686 in my data, 691 in grahn 1995 Table 7")
data <- add_warning("DI♂γ", "MAS 611 in my data, 619 in grahn 1995 Table 7")
data <- add_warning("S2♂γ", "MAS 723 in my data, 727 in grahn 1995 Table 7")
data <- add_warning("S3♂γ", "MAS 452 in my data, 460 in grahn 1995 Table 7")

# fix
data <- fix('AC♂', 'fractions', 72)
data <- fix('AC♂', 'interval', 7/3)
data <- fix('DC♂', 'fractions', 24)
data <- fix('DC♂', 'interval', 7)
data <- fix('EC♂', 'fractions', 24)
data <- fix('EC♂', 'interval', 7)
data <- fix('HC♂', 'fractions', 6)
data <- fix('HC♂', 'interval', 30.5)
data <- fix('AI♂γ', 'interval', 7/3)
data <- fix('BI♂γ', 'interval', 7)
data <- fix('EI♂γ', 'interval', 7)
data <- fix('HI♂γ', 'interval', 30.5)
data <- fix('DI♂γ', 'interval', 7)


# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




#### 1003-21 ♂ at 100 days
#
study <- "1003-21"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♂') %>%
  select(-other_treatments, -median_age, -lab, -species, -strain, -quality) %>%
  arrange(dose != 0, group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 8 & appendix J

# define
stratum_name <- "1003-21 ANL ♂ B6CF1 mice\n  γ-ray @110 days"
stratum_groups <- split("S0♂ S4♂γ S5♂γ S6♂γ S7♂γ S8♂γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split("S8♂γ"), 1, "acute 0.27 Gy/min")
data <- name_cluster(split("S7♂γ"), 2, "acute 0.20 Gy/min")
data <- name_cluster(split("S6♂γ"), 3, "acute 0.099 Gy/min")
data <- name_cluster(split("S5♂γ"), 4, "acute 0.069 Gy/min")
data <- name_cluster(split("S4♂γ"), 5, "acute 0.043 Gy/min")
controls <- controls_for(split("S0♂"), stratum_name)
data <- use(stratum_groups)

# warn
# data <- add_warning("Z3♂", "number of mice 194 in my data, 199 in grahn 1995 Table 7")

# fix
# data <- fix('AC♂', 'fractions', 72)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




# ABANDONED
#
# According to Table 8, Grahn 1995, the females have a miniscule number
# of observations for 1.4 and 2.0 Gy doses (7 mice each). Other doses
# are above 4 Gy and therefore irrelivant.
# #### 1003-21 ♀ at 100 days
# #
# study <- "1003-21"
# summary2(study) %>%
#   filter(!quality %in% 'neutrons fission',
#          sex == '♀') %>%
#   select(-other_treatments, -median_age, -lab, -species, -strain, -quality) %>%
#   arrange(dose != 0, group) %>%
#   mutate(time=dose/rate/fractions,
#          interval=round(interval),
#          dose=round(dose, 1),
#          rate=round(rate, 5)) %>%
#   print(n=100)
# 
# # source grahn 95
# # http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# # Table 8 & appendix J
# 
# # define
# stratum_name <- "1003-21 ANL ♀ B6CF1 mice\n  γ-ray @110 days"
# stratum_groups <- split("S0♀ S4♀γ S5♀γ S6♀γ S7♀γ S8♀γ")
# data <- name_stratum(stratum_groups, stratum_name)
# data <- name_cluster(split("S8♀γ"), 1, "acute 0.27 Gy/min")
# data <- name_cluster(split("S7♀γ"), 2, "acute 0.20 Gy/min")
# data <- name_cluster(split("S6♀γ"), 3, "acute 0.099 Gy/min")
# data <- name_cluster(split("S5♀γ"), 4, "acute 0.069 Gy/min")
# data <- name_cluster(split("S4♀γ"), 5, "acute 0.043 Gy/min")
# controls <- controls_for(split("S0♀"), stratum_name)
# data <- use(stratum_groups)
# 
# # warn
# # data <- add_warning("Z3♀", "number of mice 194 in my data, 199 in grahn 1995 Table 7")
# 
# # fix
# # data <- fix('AC♀', 'fractions', 72)
# 
# # check
# #   [x] species
# #   [x] strain
# #   [x] sex
# #   [x] treatment_age
# #   [x] fractions
# #   [x] interval
# #   [x] dose
# #   [x] rate
# #   [x] quality
# #   [ ] n
# #   [ ] u(age) 
# #   [ ] o(age)
# #   [ ] use
# #   [ ] stratum name
# #   [ ] cluster names
# #   [ ] defined controls
# #   [ ] added warnings


#### 1003-22 ♂ at 120 days
#
study <- "1003-22"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♂') %>%
  select(-other_treatments, -lab, -species, -strain, -sex, -quality, -median_age) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 7)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 9 & appendix J

# define
stratum_name <- "1003-22 ANL ♂ B6CF1 mice\n  γ-ray @120 days"
stratum_groups <- split("K0♂ K1♂γ K2♂γ K3♂γ K4♂γ K5♂γ K6♂γ L0♂ L1♂γ L2♂γ L3♂γ L4♂γ L5♂γ L6♂γ L7♂γ LC♂")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster("K6♂γ", 1, "24 over 168 days 0.045 Gy/min")
data <- name_cluster("K5♂γ", 2, "24 over 168 days 0.034 Gy/min")
data <- name_cluster("K4♂γ", 3, "24 over 168 days 0.017 Gy/min")
data <- name_cluster("K3♂γ", 4, "24 over 168 days 0.0085 Gy/min")
data <- name_cluster("K2♂γ", 5, "24 over 168 days 0.0037 Gy/min")
data <- name_cluster("K1♂γ", 6, "24 over 168 days 0.0018 Gy/min")
data <- name_cluster("L4♂γ", 7, "120 continuous days 1.2e-4 Gy/min")
data <- name_cluster("L3♂γ", 8, "120 continuous days 6.1e-5 Gy/min")
data <- name_cluster("L2♂γ", 9, "120 continuous days 2.6e-5 Gy/min")
data <- name_cluster("L1♂γ", 10, "120 continuous days 1.3e-5 Gy/min")
data <- name_cluster("L7♂γ", 11, "300 continuous days 6.2e-5 Gy/min")
data <- name_cluster("L6♂γ", 12, "300 continuous days 2.7e-5 Gy/min")
data <- name_cluster("L5♂γ", 13, "300 continuous days 1.3e-5 Gy/min")

controls <- controls_for("K0♂", stratum_name, get_cluster(1:6))
controls <- controls_for("L0♂", stratum_name, get_cluster(7:10))
controls <- controls_for("LC♂", stratum_name, get_cluster(11:13))
data <- use(stratum_groups)

# warn
data <- add_warning("L0♂", "MAS is 858 in my data, 862 in grahn 1995 Table 9")

# fix
data <- fix('K0♂', 'fractions', 24)
data <- fix('K0♂', 'interval', 7)
data <- fix('L0♂', 'fractions', 120)
data <- fix('L0♂', 'interval', 7/5)
data <- fix('LC♂', 'fractions', 300)
data <- fix('LC♂', 'interval', 7/5)
data <- fix(split('K1♂γ K2♂γ K3♂γ K4♂γ K5♂γ K6♂γ'), 'interval', 7)
data <- fix(split('L1♂γ L2♂γ L3♂γ L4♂γ L5♂γ L6♂γ L7♂γ'), 'interval', 7/5)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


#### 1003-23
#
# (this was in 1003-22, JM-4)



#### 1003-24 ♀
#
study <- "1003-24"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♀') %>%
  select(-other_treatments, -median_age, -species, -strain, -quality) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 11 & appendix J

# define
stratum_name <- "1003-24 ANL ♀ B6CF1 mice\n  γ-ray"
stratum_groups <- split("00♀ Q1♀γ Q2♀γ R1♀γ R2♀γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split("R2♀γ"), 1, "acute 0.27 Gy/min @520 days")
data <- name_cluster(split("R1♀γ"), 2, "acute 0.099 Gy/min @520 days")
data <- name_cluster(split("Q2♀γ"), 3, "60 over 420 days 0.0068 Gy/min @100 days")
data <- name_cluster(split("Q1♀γ"), 4, "60 over 420 days 0.0015 Gy/min @100 days")
controls <- controls_for("00♀", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("R2♀γ", "180 mice in my data, 176 in grahn 1995 Table 11")
data <- add_warning("Q1♀γ", "MAS is 770 mice in my data, 786 in grahn 1995 Table 11")
data <- add_warning("R2♀γ", "MAS is 363 mice in my data, 374 in grahn 1995 Table 11")

# fix
data <- fix(split('Q1♀γ Q2♀γ'), 'interval', 7)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



#### 1003-24 ♂
#
study <- "1003-24"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♂') %>%
  select(-other_treatments, -median_age, -age.u, -age.o, -lab, -strain, -species) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 11 & appendix J

# define
stratum_name <- "1003-24 ANL ♂ B6CF1 mice\n  γ-ray"
stratum_groups <- split("00♂ Q1♂γ Q2♂γ R1♂γ R2♂γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split("R2♂γ"), 1, "acute 0.27 Gy/min @520 days")
data <- name_cluster(split("R1♂γ"), 2, "acute 0.099 Gy/min @520 days")
data <- name_cluster(split("Q2♂γ"), 3, "60 over 420 days 0.0068 Gy/min @100 days")
data <- name_cluster(split("Q1♂γ"), 4, "60 over 420 days 0.0015 Gy/min @100 days")

controls <- controls_for("00♂", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("R2♂γ", "179 mice in my data, 178 in grahn 1995 Table 11")
data <- add_warning("00♂", "MAS 878 in my data, 887 in grahn 1995 Table 11")
data <- add_warning("R2♂γ", "MAS 390 in my data, 392 in grahn 1995 Table 11")

# fix
data <- fix(split('Q1♂γ Q2♂γ'), 'interval', 7)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


#### 1003-26 ♀ (there are no males for this one)
#
study <- "1003-26"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == '♀',
         !group %in% split("X0♀ XX♀")) %>%
  select(-other_treatments, -median_age, -age.u, -age.o, -lab, -species, -strain, -quality) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 1),
         rate=round(rate, 5)) %>%
  select(group, MAS, age.u.o) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 13 & appendix J

# define
stratum_name <- "1003-26 ANL ♀ B6CF1 mice\n  γ-ray @120 days"
stratum_groups <- split("X1♀γ X2♀γ X3♀γ XC♀")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster("X3♀γ", 1, "acute 0.043 Gy/min")
data <- name_cluster("X2♀γ", 2, "acute 0.022 Gy/min")
data <- name_cluster("X1♀γ", 3, "acute 0.011 Gy/min")
controls <- controls_for("XC♀", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("X3♀γ", "MAS is 817 in my data, 819 in grahn 1995 Table 13")

# fix
# data <- fix(split('Q1♂γ Q2♂γ'), 'interval', 7)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings


#### 1003-27 ♂ (there are no females for this one)
#
study <- "1003-27"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission') %>%
  select(-other_treatments, -median_age, -age.u, -age.o, -species, -strain, -lab) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 3),
         rate=round(rate, 5)) %>%
  select(group, MAS, age.u.o) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 14 & appendix J

# define
stratum_name <- "1003-27 ANL ♂ Peromyscus leucopus\n  γ-ray @140 days"
stratum_groups <- split("V1♂γ V2♂γ V3♂γ V4♂γ W0♂")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster("V4♂γ", 1, "acute 0.20 Gy/min")
data <- name_cluster("V3♂γ", 2, "acute 0.10 Gy/min")
data <- name_cluster("V2♂γ", 3, "acute 0.071 Gy/min")
data <- name_cluster("V1♂γ", 4, "acute 0.045 Gy/min")
controls <- controls_for("W0♂", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("W0♂", "MAS is 1319 in my data, 1321 in grahn 1995 Table 13")
data <- add_warning("V1♂γ", "MAS is 1221 in my data, 1225 in grahn 1995 Table 13")
data <- add_warning("V2♂γ", "MAS is 1203 in my data, 1211 in grahn 1995 Table 13")
data <- add_warning("V2♂γ", "MAS is 1180 in my data, 1185 in grahn 1995 Table 13")
data <- add_warning("V2♂γ", "MAS is 1022 in my data, 1027 in grahn 1995 Table 13")

# fix
data <- fix('V1♂γ', 'dose', 0.90)
data <- fix('V2♂γ', 'dose', 1.43)
data <- fix('V1♂γ', 'rate', 0.045)
data <- fix('V2♂γ', 'rate', 0.0715)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings





#### 1003-28
#
# Don't do, only neutron exposures



#### 1003-29 ♂
#
study <- "1003-29"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex %in% "♂") %>%
  select(-other_treatments, -median_age, -age.u, -age.o, -species, -strain, -lab) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 3),
         rate=round(rate, 5)) %>%
  select(group, MAS, age.u.o) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 15 & appendix J

# define
stratum_name <- "1003-29 ANL ♂ mice\n  γ-ray @110 days"
stratum_groups <- split("0X♂ 1X♂γ 2X♂γ 3X♂γ 4X♂γ 5X♂γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster("5X♂γ", 1, "60 over 420 days 5.0e-3 Gy/min")
data <- name_cluster("4X♂γ", 2, "60 over 420 days 3.7e-3 Gy/min")
data <- name_cluster("3X♂γ", 3, "60 over 420 days 2.5e-3 Gy/min")
data <- name_cluster("2X♂γ", 4, "60 over 420 days 1.7e-3 Gy/min")
data <- name_cluster("1X♂γ", 5, "60 over 420 days 0.8e-3 Gy/min")
controls <- controls_for("0X♂", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("0X♂", "MAS is 879 in my data, 882 in grahn 1995 Table 15")
data <- add_warning("2X♂γ", "MAS is 837 in my data, 840 in grahn 1995 Table 15")
data <- add_warning("3X♂γ", "MAS is 800 in my data, 832 in grahn 1995 Table 15")
data <- add_warning("4X♂γ", "MAS is 789 in my data, 813 in grahn 1995 Table 15")
data <- add_warning("5X♂γ", "MAS is 754 in my data, 793 in grahn 1995 Table 15")


# fix
data <- fix(stratum_groups, 'interval', 7)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



#### 1003-29 ♀
#
study <- "1003-29"
summary2(study) %>%
  filter(!quality %in% 'neutrons fission',
         sex == "♀") %>%
  select(-other_treatments, -median_age, -age.u, -age.o, -species, -strain, -lab) %>%
  arrange(group) %>%
  mutate(time=dose/rate/fractions,
         interval=round(interval),
         dose=round(dose, 3),
         rate=round(rate, 5)) %>%
  select(group, MAS, age.u.o) %>%
  print(n=100)

# source grahn 95
# http://s3.amazonaws.com/janus-cloud2/www/janus2/reports/complete.pdf
# Table 15 & appendix J

# define
stratum_name <- "1003-29 ANL ♀ mice\n  γ-ray @110 days"
stratum_groups <- split("0X♀ 1X♀γ 2X♀γ 3X♀γ 4X♀γ 5X♀γ")
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster("5X♀γ", 1, "60 over 420 days 5.0e-3 Gy/min")
data <- name_cluster("4X♀γ", 2, "60 over 420 days 3.7e-3 Gy/min")
data <- name_cluster("3X♀γ", 3, "60 over 420 days 2.5e-3 Gy/min")
data <- name_cluster("2X♀γ", 4, "60 over 420 days 1.7e-3 Gy/min")
data <- name_cluster("1X♀γ", 5, "60 over 420 days 0.8e-3 Gy/min")
controls <- controls_for("0X♀", stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning("3X♀γ", "MAS is 778 in my data, 782 in grahn 1995 Table 15")
data <- add_warning("4X♀γ", "MAS is 782 in my data, 784 in grahn 1995 Table 15")

# fix
data <- fix(stratum_groups, 'interval', 7)

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings




#### 1003-30
# 
# Will not use
# There are not enough treatment groups with no-injection according to
# Appendix J of Grahn 1995


#### 1007-2
#
# Will not use
# There is only one dose rate according to 3577229.pdf


#### 1007-3
#
# Will not use
# All mice were exposed at the same dose rate according to Gerber 1995


#### 3-1
#
study <- "3-1"
summary(study) %>%
  filter(quality != "neutrons 1-10 MeV",
         group != 9) %>% 
  select(-lab, -species, -strain, -sex, -fractions, -interval) %>%
  arrange(as.numeric(group)) %>%
  print(n=100)
# source 3577210.pdf


# define
stratum_name <- "3-1 ENEA ♀ BC3F1 mice\n  X-ray @35 days"
stratum_groups <- 1:8
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(6:8, 1, "acute 0.64 Gy/min")
data <- name_cluster(2:5, 2, "acute 0.06 Gy/min")
controls <- controls_for(1, stratum_name)
data <- use(stratum_groups)

# warn
data <- add_warning(groups_TODO, message_TODO)

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings



#### 3-2
#
# Will not use. X-rays have only one dose rate according to Gerber 1995.


#### 3-3
#
# Will not use. Only one dose rate according to Gerber 1995.


#### 3-4
#
# Will not use. Only one dose rate according to Gerber 1995.


#### 9-7
#
# Will not use. Only one dose rate according to Gerber 1995.

#### 11-1
#
# Will not use. Only one dose rate according to Gerber 1995.

#### 1007-1
#
# Will not use. Only one dose rate according to 3577229.pdf.

#### 1008-3
#
# Will not use. Only have control data.



#### 3-5 ♂
#
study <- "3-5"
summary(study) %>%
  filter(sex == "♂",
         quality != "neutrons fission") %>% 
  select(-lab, -species, -strain, -sex) %>%
  arrange(as.numeric(group)) %>%
  print(n=100)
# source 3576356.pdf


# define
split_n <- function(x) as.numeric(split(x))
stratum_name <- "3-5 ENEA ♂ BC3F1 mice\n  X-ray"
stratum_groups <- split_n(
  "1 3 5 7 9 19 20 21 22 23 24 25 26 27 35 36 37 38 39 40 41 42 43"
)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(split_n("3 5 7 9"), 1, 
                     "acute 0.133 Gy/min @-4 days")
data <- name_cluster(split_n("20 21 22 23 24 25 26 27"), 2, 
                     "acute 0.133 Gy/min @92 days")
data <- name_cluster(split_n("36 37 38 39 40 41 42 43"), 3, 
                     "acute 0.133 Gy/min @580 days")
controls <- controls_for(1, stratum_name, get_cluster(1))
controls <- controls_for(19, stratum_name, get_cluster(2))
controls <- controls_for(35, stratum_name, get_cluster(3))
data <- use(stratum_groups)

# warn
data <- add_warning(19, "430 mice in my data, 203 in 3576356.pdf")
data <- add_warning(19, "mean age 824 in my data, 827 in 3576356.pdf")
data <- add_warning(5, "mean age 822 in my data, 824 in 430 mice in 3576356.pdf")
data <- add_warning(37, "mean age 868 in my data, 865 in 430 mice in 3576356.pdf")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings

#### 2-11 ♀
# 
# Not enough distinct treatment groups to use

#### 2-11 ♂
#
# Will not use. There are not controls. No way to consult primary sources
# and lots of weirdness in the data. Too bad too, its one of the few studies
# I have on lifespan effects :(.

# study <- "2-11"
# summary(study) %>%
#   filter(sex == '♂',
#          !group %in% c(1, 2, 3, 4)) %>% 
#   select(-lab, -species, -strain, -sex) %>%
#   arrange(as.numeric(group)) %>%
#   print(n=100)
# # source TODO.pdf
# 
# 
# # define
# stratum_name <- "TODO-TODO TODO ♀ TODO mice\n  TODO-ray"
# stratum_groups <- TODO:TODO
# data <- name_stratum(stratum_groups, stratum_name)
# data <- name_cluster(TODO:TODO, 1, "acute TODO Gy/min @TODO days")
# controls <- controls_for(TODO, get_cluster(TODO))
# data <- use(stratum_groups)
# 
# # warn
# # data <- add_warning(groups_TODO, message_TODO)
# 
# # fix
# data[data$study == study, 'strain'] <- 'Sprague-Dawley'
# data[data$study == study & data$group == 6, 'treatment_age'] <- -21 + 8
# data[data$study == study & data$group == 8, 'treatment_age'] <- -21 + 8
# data[data$study == study & data$group == 10, 'treatment_age'] <- -21 + 8
# data[data$study == study & data$group == 11, 'treatment_age'] <- round(3 * 30.5)
# data[data$study == study & data$group == 12, 'treatment_age'] <- round(3 * 30.5)
# data[data$study == study & data$group == 13, 'treatment_age'] <- round(3 * 30.5)
# data[data$study == study & data$group == 15, 'treatment_age'] <- round(9 * 30.5)
# 
# data[data$study == study & data$group == 6, 'fractions'] <- 
#   round((2.66 * 1000) / (4.5 * 53))  # ~ 
# data[data$study == study & data$group == 8, 'fractions'] <- 
#   round((5.96 * 1000) / (3.4 * 53))   # ~ 33
# data[data$study == study & data$group == 10, 'fractions'] <- 
#   round((14.74 * 1000) / (3.4 * 53))  # ~ 82
# data[data$study == study & data$group == 11, 'fractions'] <- 
#   round((1 * 1000) / (2.6 * 78))
# 
# 78 (≈2.6h/d 5d)
# 
# data[data$study == study & data$group == 15, 'dose'] <- 3.0
# 
# # check
# #   [x] species
# #   [x] strain
# #   [x] sex
# #   [x] treatment_age
# #   [ ] fractions
# #   [ ] interval
# #   [x] dose
# #   [ ] rate
# #   [ ] quality
# #   [ ] n
# #   [ ] u(age) 
# #   [ ] o(age)
# #   [ ] use
# #   [ ] stratum name
# #   [ ] cluster names
# #   [ ] defined controls
# #   [ ] added warnings
# 



#### 9-7
#
study <- "9-7"
summary(study) %>%
  filter(quality != 'neutrons 1-10 MeV') %>% 
  arrange(as.numeric(group)) %>%
  print(n=100)
# source 3579307.pdf


# define
stratum_name <- "9-7 SCK/CEN ♂ C57BL/Cnb mice\n  X-ray"
stratum_groups <- c(1, 10:15)
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(10:12, 1, "acute 1 Gy/min @7 days")
data <- name_cluster(13:15, 2, "acute 1 Gy/min @21 days")
controls <- controls_for(1, stratum_name, get_cluster(1))
controls <- controls_for(1, stratum_name, get_cluster(2))
data <- use(stratum_groups)

# warn
data <- add_warning(1, "I have 105 animals, Gerber says I should have 165")
data <- add_warning(10, "My mean age is 777, 3579307.pdf says it should be 774")

# fix

# check
#   [x] species
#   [x] strain
#   [x] sex
#   [x] treatment_age
#   [x] fractions
#   [x] interval
#   [x] dose
#   [x] rate
#   [x] quality
#   [x] n
#   [x] u(age) 
#   [x] o(age)
#   [x] use
#   [x] stratum name
#   [x] cluster names
#   [x] defined controls
#   [x] added warnings





#### TODO-TODO
#
study <- "TODO-TODO"
summary(study) %>%
  filter(TODO) %>% 
  select() %>%
  arrange(as.numeric(group)) %>%
  print(n=100)
# source TODO.pdf


# define
stratum_name <- "TODO-TODO TODO ♀ TODO mice\n  TODO-ray"
stratum_groups <- TODO:TODO
data <- name_stratum(stratum_groups, stratum_name)
data <- name_cluster(TODO:TODO, 1, "acute TODO Gy/min @TODO days")
controls <- controls_for(TODO, get_cluster(TODO))
data <- use(stratum_groups)

# warn
# data <- add_warning(groups_TODO, message_TODO)

# fix

# check
#   [ ] species
#   [ ] strain
#   [ ] sex
#   [ ] treatment_age
#   [ ] fractions
#   [ ] interval
#   [ ] dose
#   [ ] rate
#   [ ] quality
#   [ ] n
#   [ ] u(age) 
#   [ ] o(age)
#   [ ] use
#   [ ] stratum name
#   [ ] cluster names
#   [ ] defined controls
#   [ ] added warnings

# Split Janus clusters by age
#
# Most of the janus studies included animals irradiated at slightly
# different ages (+/- 1 week) these can be treated as independent
# clusters to test the effects age at exposore
quantile0 <- function(...) quantile(..., na.rm = TRUE)
split_point <- function(x) {
  as.numeric((quantile0(x, 0.25) + quantile0(x, 0.75)) / 2)
}
anl <- 
  !is.na(data$treatment_age) &
  !is.na(data$use) & 
  data$use & 
  data$lab == "ANL" & 
  data$dose > 0

# Modify data cluster
data$older = NA
data[anl,] <- ddply(data[anl,], .(stratum, cluster), function(df) {
  df$older <- df$treatment_age > split_point(df$treatment_age)

  df
})


### Finaly tidy
to_save <- data %>%
  # Remove old columns
  select(-old_exclude, 
         -old_warning, 
         -old_warning_reason,
         -other_treatments) %>%
  # Only selected
  filter(use)

# Properly set fractions and intervals 
# for controls and acute exposures
.controls <- to_save$dose == 0
to_save$fractions[.controls] <- 0
to_save$interval[.controls] <- 0
.acute <- to_save$fractions == 1
to_save$interval[.acute] <- (to_save$dose[.acute] / to_save$rate[.acute]) / (24*60)

# Add the last treatment age
acute <- to_save$fractions == 1
fractionated <- to_save$fractions > 1
to_save$last_treatment_age[acute] <- to_save$treatment_age[acute]
to_save$last_treatment_age[fractionated] <- 
  to_save$treatment_age[fractionated] + 
  to_save$fractions[fractionated] * to_save$interval[fractionated]


saveRDS(to_save, file='data/thesis.rds')
saveRDS(controls, file='data/thesis_controls.rds')
```

